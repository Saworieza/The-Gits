define(["jquery","underscore","js/core/coursera","pages/home/template/body","pages/specialization/views/landingPage.html","i18n!js/json/nls/specializations","js/collections/courses","pages/specialization/views/topicSideBox.html","pages/specialization/views/topicPreviewBox","pages/specialization/views/institutePreviewBox.html","pages/specialization/views/instructorIcon.html","js/models/specialization","js/json/specialization_faq","js/lib/coursera.ab","js/lib/tooltips","js/lib/util","js/lib/modals","js/lib/truncate","js/lib/prices","js/lib/bootstrap-transition","js/lib/affix"],function($,_,Coursera,body,template,_t,Courses,topicSideTemplate,TopicTemplate,InstituteTemplate,InstructorTemplate,Specialization,faqJSON,AB,tooltips,util,Modal,truncate,prices){var pageBody=body.extend({events:{"click .topics-side-list .coursera-specialization-unit-sidebox":"chooseTopic","click .video-placeholder":"playVideo","click .close-video-btn":"closeVideo","click .show-all-link":"showAllElements","mouseover [data-mouseover-event]":"eventMouseOver","click [data-click-event]":"eventClick","change .coursera-specialization-topic .course-selector":"chooseSession"},eventClick:function(e){Coursera.multitracker.push(["Specialization help",$(e.currentTarget).attr("data-click-event")])},eventMouseOver:function(e){Coursera.multitracker.push(["Specialization mouseover",$(e.currentTarget).attr("data-mouseover-event")])},showAllElements:function(e){var classToShow=$(e.currentTarget).attr("data-class-to-show"),classToHide=$(e.currentTarget).attr("data-class-to-hide");if(classToHide)this.$el.find("."+classToHide).hide();if(classToShow)this.$el.find("."+classToShow).show();this.$(e.currentTarget).hide(),Coursera.multitracker.push(["Specialization showAll",classToShow])},showPreviewBanner:function(){var self=this;if($(".coursera-browser-banner").length>0)return;var $browserBanner=$('<div class="coursera-browser-banner">');$browserBanner.css({"text-align":"center","font-size":"16px",padding:"10px 0px",background:"#F4C2C2","margin-top":"-100px","border-bottom":"1px solid #CCC"}),$browserBanner.html("This is a preview. The student view will be located at www.coursera.org/specialization/"+self.model.get("short_name")+"/"+self.model.get("id")),$(document.body).prepend($browserBanner),$browserBanner.animate({"margin-top":"+=100px"},1e3)},closeVideo:function(){this.$(".what-youll-learn-row").show(),this.$(".video-row").hide(),this.$el.find(".coursera-specialization-video").removeAttr("src")},playVideo:function(){this.$(".what-youll-learn-row").hide(),this.$(".video-row").show(),this.$el.find(".coursera-specialization-video").attr("src","https://www.youtube.com/embed/"+this.model.get("video")+"?rel=0&autoplay=1&wmode=transparent"),util.scrollToInternalLink(this.$el,"overview")},addHybridPaymentInteractions:function(){var self=this;this.$("[data-bulk-option-available=1]").show();var $modalDiv=this.$(".coursera-specialization-modal-payment-options"),$topicSelector=$modalDiv.find("[data-select-topic] select"),$courseSelector=$modalDiv.find("[data-select-course] select");$courseSelector.on("change",function(){var coursePaymentLink=Coursera.config.url.base+"signature/specializationPayment/"+$topicSelector.val()+"/"+$courseSelector.val();$modalDiv.find(".pay-as-you-go .coursera-specialization-modal-btn-link").attr("href",coursePaymentLink)}),$topicSelector.on("change",function(){var addSessions=function(nullObject,topic){for(var courses=Courses.haveActiveSignatureTrack(topic.get("courses")),optionsString="",i=0;i<courses.length;i++){var course=courses[i];optionsString+="<option value="+course.get("id")+">"+course.getStartDisplayShort()+"</option>"}if(optionsString.length)$courseSelector.empty().append(optionsString).show().change(),$modalDiv.find("[data-num-sessions=0]").hide();else $courseSelector.hide(),$modalDiv.find("[data-num-sessions=0]").show()},topicChosen=$topicSelector.val();self.model.get("topics").getByShortName(topicChosen,addSessions)}),$topicSelector.change(),this.paymentOptionModal=Modal($modalDiv),this.$(".coursera-specialization-topic .course-selector").change(),this.$(".topic-enroll-section a").on("click",function(e){$topicSelector.val($(e.currentTarget).find("[data-topic-short-name]").attr("data-topic-short-name")).change(),self.paymentOptionModal.open()}),this.$(".get-started-btn").on("click",function(){self.paymentOptionModal.open()}).show()},addSinglePaymentInteractions:function(){var self=this;this.$("[data-bulk-option-available=0]").show();var btnLinkPerTopic=Coursera.config.url.base+"signature/specializationCourse/";if(Coursera.user.completedAllSTProfile())btnLinkPerTopic=Coursera.config.url.base+"signature/specializationPayment/";this.$(".coursera-specialization-topic .course-selector").on("change",function(e){var $selector=$(e.currentTarget),courseID=$selector.val(),topicShortName=$selector.attr("data-topic-short-name"),$topicDiv=$selector.closest(".coursera-specialization-topic");self.updateTopicPreviewDisplay($topicDiv,courseID);var $enrollLink=$topicDiv.find(".enroll-vc-link");if(topicShortName){var linkPrefix=topicShortName+"/"+courseID+"?utm_medium=specializationLanding";if(!Coursera.user.enrolledInSignatureCourse(courseID))$enrollLink.attr("href",btnLinkPerTopic+linkPrefix);else $enrollLink.attr("href",Coursera.config.url.base+"signature/specializationCourse/"+linkPrefix)}}),this.$(".coursera-specialization-topic .course-selector").change(),this.$(".get-started-btn").on("click",function(){util.scrollToInternalLink(self.$el,"courses")}).show()},addPaymentInteractions:function(){var self=this;if(Coursera.user.get("authenticated")){var numEnrolledIn=0,numWithSigtrackOpen=this.model.get("topics").length;if(Coursera.user.get("enrollmentList")){var topicIdList=_.map(this.model.get("topics").models,function(topic){return topic.get("id")}),enrolledTopics=_.reduce(Coursera.user.get("enrollmentList"),function(acc,course){if(_.contains(topicIdList,course.course__topic_id)&&course.authenticated_track)acc.push(course.course__topic_id);return acc},[]);numEnrolledIn=_.uniq(enrolledTopics).length,numWithSigtrackOpen=_.reduce(this.model.get("topics").models,function(acc,topic){if(topic.get("is_capstone"))acc++;else if(enrolledTopics.indexOf(topic.get("id"))<0)for(var courses=topic.get("courses").models,i=0;i<courses.length;i++){var course=courses[i],sigtrackOpen=course.get("eligible_for_signature_track")&&course.get("signature_track_registration_open"),futureCourse=course.get("status")&&"future"===course.getStartStatus();if(sigtrackOpen||futureCourse){acc++;break}}return acc},0)}if(this.model.get("topics").length==numEnrolledIn+numWithSigtrackOpen)this.addHybridPaymentInteractions();else this.addSinglePaymentInteractions()}else this.addSinglePaymentInteractions()},chooseTopic:function(e){var topicUnit=$(e.currentTarget).attr("data-unit"),$sideBoxes=this.$(".topics-side-list");$sideBoxes.find(".coursera-specialization-unit-sidebox").removeClass("active"),$sideBoxes.find(".coursera-specialization-unit-sidebox[data-unit="+topicUnit+"]").addClass("active");var $topicDetailBoxes=this.$(".topics-list");$topicDetailBoxes.find(".coursera-specialization-topic").hide(),$topicDetailBoxes.find(".coursera-specialization-topic[data-unit="+topicUnit+"]").show(),Coursera.multitracker.push(["Specialization Topic","choose"])},updateTopicPreviewDisplay:function($topicDiv,courseID){if($topicDiv.find("[data-course-id]").hide(),$topicDiv.find("[data-course-id="+courseID+"]").show(),Coursera.user.enrolledInSignatureCourse(courseID))$topicDiv.find("[data-sigtrack-enrolled=1]").show(),$topicDiv.find("[data-sigtrack-enrolled=0]").hide();else $topicDiv.find("[data-sigtrack-enrolled=0]").show(),$topicDiv.find("[data-sigtrack-enrolled=1]").hide()},chooseSession:function(e){var $selector=$(e.currentTarget),courseID=$selector.val();this.updateTopicPreviewDisplay($selector.closest(".coursera-specialization-topic"),courseID)},addSpecializationCourses:function(){var self=this,topics=self.model.get("topics");_.each(topics.toArray(),function(topic,index){var topicSideBox=topicSideTemplate({config:Coursera.config,topicName:truncate.byLength(topic.get("name"),50),unitIndex:index,isCapstone:topic.get("is_capstone")}),topicBox=new TopicTemplate({topic:topic,is_capstone:topic.get("is_capstone"),capstone:topic.get("is_capstone")?self.model.get("aux_info").capstone:{},unitIndex:index}),$topicSideBox=$(topicSideBox);if(0===index)$topicSideBox.addClass("active");self.$(".topics-side-list").append($topicSideBox);var $topicDetailBox=topicBox.render().$el;self.$(".topics-list").append($topicDetailBox)})},initialize:function(){var self=this;document.title="Specialization | Coursera",self.bind("view:appended",function(){if(self.model.get("preview"))self.showPreviewBanner();var institutionNames="",totalUniversities=self.model.get("universities").length;_.each(self.model.get("universities").toArray(),function(university,index){if(totalUniversities>1&&0!==index)if(index===totalUniversities-1)institutionNames+=" & ";else institutionNames+=", ";institutionNames+=university.get("name")});var instructorHeading="Instructor"+(self.model.get("instructors").length>1?"s":""),fullFAQ=[];if(self.model.get("default_faqs"))fullFAQ=JSON.parse(self.model.get("default_faqs"));if(self.model.get("faqs"))fullFAQ=fullFAQ.concat(JSON.parse(self.model.get("faqs")));var expSubheadField=null;if(self.model.get("subhead")&&self.model.get("subhead").length>0)expSubheadField=AB.session.getExperiment("specializations_subhead_field").getChosenVariant();else expSubheadField="base";var distinctionRequired=!1;if(self.model.get("aux_info").distinctionRequired)distinctionRequired=!0;var expSpecializationsLandingSwap=AB.session.getExperiment("specializations_landing_swap").getChosenVariant(),universityLogos=[];if(self.model.get("cert_logo"))universityLogos.push(self.model.get("cert_logo"));else _.each(self.model.get("universities").models,function(university){if(!self.model.get("aux_info").omit_logo||self.model.get("aux_info").omit_logo.indexOf(university.get("id"))<0)universityLogos.push(university.get("logo")||university.get("class_logo"))});var previewMode=self.model.get("preview")?"preview/":"",urlPrefix=Coursera.config.dir.home+"specialization/"+previewMode+self.model.get("short_name")+"/"+self.model.get("id")+"/";if(self.$el.append(template({_t:_t,_localize:prices.localize,symBefore:prices.symBefore(),config:Coursera.config,model:self.model,institutionNames:institutionNames,faqQuestions:fullFAQ,urlPrefix:urlPrefix,expSubheadField:expSubheadField,instructorHeading:instructorHeading,specializationID:self.model.get("id"),distinctionRequired:distinctionRequired,universityLogos:universityLogos,expSpecializationsLandingSwap:expSpecializationsLandingSwap})),Coursera.user.get("authenticated"))Coursera.user.getEnrollmentList().done(function(data){self.addSpecializationCourses(),self.addPaymentInteractions()});else self.addSpecializationCourses(),self.addPaymentInteractions();var squareLogoOverride=self.model.get("aux_info").square_logo_override,institutes=self.model.get("universities"),instituteDictionary={};_.each(institutes.toArray(),function(institute){var instituteHTML=InstituteTemplate({config:Coursera.config,institution:institute,squareLogo:squareLogoOverride?squareLogoOverride[institute.get("id")]:null});self.$(".institutes-list").append(instituteHTML),instituteDictionary[institute.get("name")]=institute.get("short_name")});var instructors=self.model.get("instructors");_.each(instructors.toArray(),function(instructor){var instructorHTML=InstructorTemplate({instructor:instructor,config:Coursera.config,hideUniversity:1===institutes.length,instituteDictionary:instituteDictionary});self.$(".instructors-list").append(instructorHTML)});for(var $col1=$(".coursera-specialization-faq .faq-column1"),$col2=$(".coursera-specialization-faq .faq-column2");$col1.height()>$col2.height();)$col2.prepend($col1.find(".faq-item").last().detach());if($col1.append($col2.find(".faq-item").first().detach()),util.setupInternalLinks(self),self.$el.find(".coursera-sigtrack-tooltip").attr("data-tooltip",self.$el.find(".coursera-sigtrack-tooltip-display").parent().html()),self.options.section)util.scrollToInternalLink(self.$el,self.options.section)})},trackConversionEvents:function(){AB.session.getExperiment("specializations_list_subheader").convert("landingPage")},render:function(){return this.trackConversionEvents(),this.model=this.options.model,this}});return pageBody});