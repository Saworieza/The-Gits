function FastClick(b){var c,a=this;this.trackingClick=false;this.trackingClickStart=0;this.targetElement=null;this.touchStartX=0;this.touchStartY=0;this.lastTouchIdentifier=0;this.touchBoundary=10;this.layer=b;if(!b||!b.nodeType){throw new TypeError("Layer must be a document node")}this.onClick=function(){return FastClick.prototype.onClick.apply(a,arguments)};this.onMouse=function(){return FastClick.prototype.onMouse.apply(a,arguments)};this.onTouchStart=function(){return FastClick.prototype.onTouchStart.apply(a,arguments)};this.onTouchEnd=function(){return FastClick.prototype.onTouchEnd.apply(a,arguments)};this.onTouchCancel=function(){return FastClick.prototype.onTouchCancel.apply(a,arguments)};if(FastClick.notNeeded(b)){return}if(this.deviceIsAndroid){b.addEventListener("mouseover",this.onMouse,true);b.addEventListener("mousedown",this.onMouse,true);b.addEventListener("mouseup",this.onMouse,true)}b.addEventListener("click",this.onClick,true);b.addEventListener("touchstart",this.onTouchStart,false);b.addEventListener("touchend",this.onTouchEnd,false);b.addEventListener("touchcancel",this.onTouchCancel,false);if(!Event.prototype.stopImmediatePropagation){b.removeEventListener=function(e,g,d){var f=Node.prototype.removeEventListener;if(e==="click"){f.call(b,e,g.hijacked||g,d)}else{f.call(b,e,g,d)}};b.addEventListener=function(f,g,e){var d=Node.prototype.addEventListener;if(f==="click"){d.call(b,f,g.hijacked||(g.hijacked=function(h){if(!h.propagationStopped){g(h)}}),e)}else{d.call(b,f,g,e)}}}if(typeof b.onclick==="function"){c=b.onclick;b.addEventListener("click",function(d){c(d)},false);b.onclick=null}}FastClick.prototype.deviceIsAndroid=navigator.userAgent.indexOf("Android")>0;FastClick.prototype.deviceIsIOS=/iP(ad|hone|od)/.test(navigator.userAgent);FastClick.prototype.deviceIsIOS4=FastClick.prototype.deviceIsIOS&&(/OS 4_\d(_\d)?/).test(navigator.userAgent);FastClick.prototype.deviceIsIOSWithBadTarget=FastClick.prototype.deviceIsIOS&&(/OS ([6-9]|\d{2})_\d/).test(navigator.userAgent);FastClick.prototype.needsClick=function(a){switch(a.nodeName.toLowerCase()){case"button":case"select":case"textarea":if(a.disabled){return true}break;case"input":if((this.deviceIsIOS&&a.type==="file")||a.disabled){return true}break;case"label":case"video":return true}return(/\bneedsclick\b/).test(a.className)};FastClick.prototype.needsFocus=function(a){switch(a.nodeName.toLowerCase()){case"textarea":case"select":return true;case"input":switch(a.type){case"button":case"checkbox":case"file":case"image":case"radio":case"submit":return false}return !a.disabled&&!a.readOnly;default:return(/\bneedsfocus\b/).test(a.className)}};FastClick.prototype.sendClick=function(b,c){var a,d;if(document.activeElement&&document.activeElement!==b){document.activeElement.blur()}d=c.changedTouches[0];a=document.createEvent("MouseEvents");a.initMouseEvent("click",true,true,window,1,d.screenX,d.screenY,d.clientX,d.clientY,false,false,false,false,0,null);a.forwardedTouchEvent=true;b.dispatchEvent(a)};FastClick.prototype.focus=function(a){var b;if(this.deviceIsIOS&&a.setSelectionRange){b=a.value.length;a.setSelectionRange(b,b)}else{a.focus()}};FastClick.prototype.updateScrollParent=function(b){var c,a;c=b.fastClickScrollParent;if(!c||!c.contains(b)){a=b;do{if(a.scrollHeight>a.offsetHeight){c=a;b.fastClickScrollParent=a;break}a=a.parentElement}while(a)}if(c){c.fastClickLastScrollTop=c.scrollTop}};FastClick.prototype.getTargetElementFromEventTarget=function(a){if(a.nodeType===Node.TEXT_NODE){return a.parentNode}return a};FastClick.prototype.onTouchStart=function(c){var a,d,b;if(c.targetTouches.length>1){return true}a=this.getTargetElementFromEventTarget(c.target);d=c.targetTouches[0];if(this.deviceIsIOS){b=window.getSelection();if(b.rangeCount&&!b.isCollapsed){return true}if(!this.deviceIsIOS4){if(d.identifier===this.lastTouchIdentifier){c.preventDefault();return false}this.lastTouchIdentifier=d.identifier;this.updateScrollParent(a)}}this.trackingClick=true;this.trackingClickStart=c.timeStamp;this.targetElement=a;this.touchStartX=d.pageX;this.touchStartY=d.pageY;if((c.timeStamp-this.lastClickTime)<200){c.preventDefault()}return true};FastClick.prototype.touchHasMoved=function(a){var c=a.changedTouches[0],b=this.touchBoundary;if(Math.abs(c.pageX-this.touchStartX)>b||Math.abs(c.pageY-this.touchStartY)>b){return true}return false};FastClick.prototype.findControl=function(a){if(a.control!==undefined){return a.control}if(a.htmlFor){return document.getElementById(a.htmlFor)}return a.querySelector("button, input:not([type=hidden]), keygen, meter, output, progress, select, textarea")};FastClick.prototype.onTouchEnd=function(c){var e,d,b,g,f,a=this.targetElement;if(this.touchHasMoved(c)){this.trackingClick=false;this.targetElement=null}if(!this.trackingClick){return true}if((c.timeStamp-this.lastClickTime)<200){this.cancelNextClick=true;return true}this.lastClickTime=c.timeStamp;d=this.trackingClickStart;this.trackingClick=false;this.trackingClickStart=0;if(this.deviceIsIOSWithBadTarget){f=c.changedTouches[0];a=document.elementFromPoint(f.pageX-window.pageXOffset,f.pageY-window.pageYOffset)}b=a.tagName.toLowerCase();if(b==="label"){e=this.findControl(a);if(e){this.focus(a);if(this.deviceIsAndroid){return false}a=e}}else{if(this.needsFocus(a)){if((c.timeStamp-d)>100||(this.deviceIsIOS&&window.top!==window&&b==="input")){this.targetElement=null;return false}this.focus(a);if(!this.deviceIsIOS4||b!=="select"){this.targetElement=null;c.preventDefault()}return false}}if(this.deviceIsIOS&&!this.deviceIsIOS4){g=a.fastClickScrollParent;if(g&&g.fastClickLastScrollTop!==g.scrollTop){return true}}if(!this.needsClick(a)){c.preventDefault();this.sendClick(a,c)}return false};FastClick.prototype.onTouchCancel=function(){this.trackingClick=false;this.targetElement=null};FastClick.prototype.onMouse=function(a){if(!this.targetElement){return true}if(a.forwardedTouchEvent){return true}if(!a.cancelable){return true}if(!this.needsClick(this.targetElement)||this.cancelNextClick){if(a.stopImmediatePropagation){a.stopImmediatePropagation()}else{a.propagationStopped=true}a.stopPropagation();a.preventDefault();return false}return true};FastClick.prototype.onClick=function(a){var b;if(this.trackingClick){this.targetElement=null;this.trackingClick=false;return true}if(a.target.type==="submit"&&a.detail===0){return true}b=this.onMouse(a);if(!b){this.targetElement=null}return b};FastClick.prototype.destroy=function(){var a=this.layer;if(this.deviceIsAndroid){a.removeEventListener("mouseover",this.onMouse,true);a.removeEventListener("mousedown",this.onMouse,true);a.removeEventListener("mouseup",this.onMouse,true)}a.removeEventListener("click",this.onClick,true);a.removeEventListener("touchstart",this.onTouchStart,false);a.removeEventListener("touchend",this.onTouchEnd,false);a.removeEventListener("touchcancel",this.onTouchCancel,false)};FastClick.notNeeded=function(b){var a;if(typeof window.ontouchstart==="undefined"){return true}if((/Chrome\/[0-9]+/).test(navigator.userAgent)){if(FastClick.prototype.deviceIsAndroid){a=document.querySelector("meta[name=viewport]");if(a&&a.content.indexOf("user-scalable=no")!==-1){return true}}else{return true}}if(b.style.msTouchAction==="none"){return true}return false};FastClick.attach=function(a){return new FastClick(a)};if(typeof define!=="undefined"&&define.amd){define(function(){return FastClick})}else{if(typeof module!=="undefined"&&module.exports){module.exports=FastClick.attach;module.exports.FastClick=FastClick}else{window.FastClick=FastClick}}(function(b,a){var c=b(a);b.fn.lazyload=function(d){var f=this;var g;var e={threshold:0,failure_limit:0,event:"scroll",effect:"show",container:a,data_attribute:"original",skip_invisible:true,appear:null,load:null};function h(){var i=0;f.each(function(){var j=b(this);if(e.skip_invisible&&!j.is(":visible")){return}if(b.abovethetop(this,e)||b.leftofbegin(this,e)){}else{if(!b.belowthefold(this,e)&&!b.rightoffold(this,e)){j.trigger("lazyload:appear")}else{if(++i>e.failure_limit){return false}}}})}if(d){if(undefined!==d.failurelimit){d.failure_limit=d.failurelimit;delete d.failurelimit}if(undefined!==d.effectspeed){d.effect_speed=d.effectspeed;delete d.effectspeed}b.extend(e,d)}g=(e.container===undefined||e.container===a)?c:b(e.container);if(0===e.event.indexOf("scroll")){g.bind(e.event,function(i){return h()})}this.each(function(){var l=this;var p=b(l);l.loaded=false;l.error_event_set=false;var i=4000,o=4,m=0;var j=function(){if(!this.loaded){if(e.appear){var r=f.length;e.appear.call(l,r,e)}if(this.tagName==="IMG"){b("<img />").bind("load",function(){p.hide().attr("src",p.data(e.data_attribute))[e.effect](e.effect_speed);l.loaded=true;var s=b.grep(f,function(u){return !u.loaded});f=b(s);if(e.load){var t=f.length;e.load.call(l,t,e)}}).bind("error",function(){if(!l.error_event_set){a.setTimeout(b.proxy(n,this),i)}l.error_event_set=true}).attr("src",p.data(e.data_attribute))}else{p.css("background-image","url("+p.data(e.data_attribute)+")")[e.effect](e.effect_speed);l.loaded=true;var q=b.grep(f,function(s){return !s.loaded});f=b(q);if(e.load){var r=f.length;e.load.call(l,r,e)}}}};var n=function(){m+=1;if(m<=o){b(this).bind("error",function(){a.setTimeout(b.proxy(n,this),i)});var q=this.src.split("?")[0];this.src=q+"?"+new Date().getTime()}};p.one("lazyload:appear",j);if(0!==e.event.indexOf("scroll")){p.bind(e.event,function(q){if(!l.loaded){p.trigger("lazyload:appear")}})}});c.bind("resize",function(i){h()});h();return this};b.belowthefold=function(e,f){var d;if(f.container===undefined||f.container===a){d=c.height()+c.scrollTop()}else{d=b(f.container).offset().top+b(f.container).height()}return d<=b(e).offset().top-f.threshold};b.rightoffold=function(e,f){var d;if(f.container===undefined||f.container===a){d=c.width()+c.scrollLeft()}else{d=b(f.container).offset().left+b(f.container).width()}return d<=b(e).offset().left-f.threshold};b.abovethetop=function(e,f){var d;if(f.container===undefined||f.container===a){d=c.scrollTop()}else{d=b(f.container).offset().top}return d>=b(e).offset().top+f.threshold+b(e).height()};b.leftofbegin=function(e,f){var d;if(f.container===undefined||f.container===a){d=c.scrollLeft()}else{d=b(f.container).offset().left}return d>=b(e).offset().left+f.threshold+b(e).width()};b.inviewport=function(d,e){return !b.rightofscreen(d,e)&&!b.leftofscreen(d,e)&&!b.belowthefold(d,e)&&!b.abovethetop(d,e)};b.extend(b.expr[":"],{"below-the-fold":function(d){return b.belowthefold(d,{threshold:0})},"above-the-top":function(d){return !b.belowthefold(d,{threshold:0})},"right-of-screen":function(d){return b.rightoffold(d,{threshold:0})},"left-of-screen":function(d){return !b.rightoffold(d,{threshold:0})},"in-viewport":function(d){return !b.inviewport(d,{threshold:0})},"above-the-fold":function(d){return !b.belowthefold(d,{threshold:0})},"right-of-fold":function(d){return b.rightoffold(d,{threshold:0})},"left-of-fold":function(d){return !b.rightoffold(d,{threshold:0})}})})(jQuery,window);
/*!
 * Play GIF
 * 
 * by Jesse Young
 *
 * a jQuery plugin to play GIF animations on mouseover (or any other event).
 * 
 * Examples:
 *    $('img[src$=".gif"]').playGIF();             // default is mouseover
 *    $('img[src$=".gif"]').playGIF({on:'click'}); // play animation on click
 */
;var PLAYGIF_DISABLE_FLAG;(function(a){a.fn.playGIF=function(c){var d=a.extend({on:"mouseenter",off:"mouseleave",autoResize:false,enable:true,circleBackgroundColor:"FFF200",circleTextColor:"4C4E4D",removeAnchor:true},c);if(typeof PLAYGIF_DISABLE_FLAG!=="undefined"){d.enable=!PLAYGIF_DISABLE_FLAG}var b=function(g,f,h){f=Math.floor(f);h=Math.floor(h);var e=35;g.fillStyle="#"+d.circleBackgroundColor;g.beginPath();g.arc(f,h,e,0,Math.PI*2,true);g.closePath();g.fill();g.fillStyle="#"+d.circleTextColor;g.font="15px 'Gotham SSm A', 'Gotham SSm B', sans-serif";g.textAlign="center";g.textBaseline="middle";g.fillText("GIF",f,h)};return this.each(function(){if(d.enable===false){return}var j=a(this);if(!j.is("img")||!/\.gif$/i.test(j.attr("src"))){return true}var h=document.createElement("canvas");if(typeof h.getContext==="undefined"){return true}var i=h.getContext("2d");var g=new Image();var f=function(m,l){l.on(d.off,function(){e(m,l)});var n=l.attr("src");l.attr("src","data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==");l.css({width:m.attr("width"),height:m.attr("height")});setTimeout(function(){l.attr("src",n)},0);m.replaceWith(l)};var e=function(m,l){m.on(d.on,function(){f(m,l)});l.replaceWith(m)};g.onload=function(){var m=j.width();var l=j.height();h.width=m;h.height=l;i.drawImage(g,0,0,m,l);var n=a(h);if(d.autoResize===true){h.setAttribute("data-src",j.attr("src"));h.setAttribute("class","gif");var p=a('<span class="faux-image">');p.css({"float":j.css("float"),margin:j.css("margin"),padding:j.css("padding"),"max-width":"100%",position:"relative",display:"block",height:h.height});n.css({position:"absolute",top:0,left:0});n=p.append(n)}else{n.css({"float":j.css("float"),margin:j.css("margin"),padding:j.css("padding"),display:j.css("display")})}j.replaceWith(n);var o=n.parent();if(!o.is("p")&&(o.css("max-width")!=="none"||o.css("max-height")!=="none")){m=o.width();l=o.height()}if(d.removeAnchor){if(o.is("a")&&/\.gif$/i.test(o.attr("href"))){o.replaceWith(n)}}if(m>150&&l>150){b(i,m/2,l/2)}n.on(d.on,function(){f(n,j)})};g.src=j.attr("src")})}})(jQuery);(function(b,d){if(b.rails!==d){b.error("jquery-ujs has already been loaded!")}var a;var c=b(document);b.rails=a={linkClickSelector:"a[data-confirm], a[data-method], a[data-remote], a[data-disable-with]",buttonClickSelector:"button[data-remote], button[data-confirm]",inputChangeSelector:"select[data-remote], input[data-remote], textarea[data-remote]",formSubmitSelector:"form",formInputClickSelector:"form input[type=submit], form input[type=image], form button[type=submit], form button:not([type])",disableSelector:"input[data-disable-with], button[data-disable-with], textarea[data-disable-with]",enableSelector:"input[data-disable-with]:disabled, button[data-disable-with]:disabled, textarea[data-disable-with]:disabled",requiredInputSelector:"input[name][required]:not([disabled]),textarea[name][required]:not([disabled])",fileInputSelector:"input[type=file]",linkDisableSelector:"a[data-disable-with]",CSRFProtection:function(f){var e=b('meta[name="csrf-token"]').attr("content");if(e){f.setRequestHeader("X-CSRF-Token",e)}},refreshCSRFTokens:function(){var e=b("meta[name=csrf-token]").attr("content");var f=b("meta[name=csrf-param]").attr("content");b('form input[name="'+f+'"]').val(e)},fire:function(h,e,g){var f=b.Event(e);h.trigger(f,g);return f.result!==false},confirm:function(e){return confirm(e)},ajax:function(e){return b.ajax(e)},href:function(e){return e.attr("href")},handleRemote:function(j){var e,f,i,n,g,h,m,o;if(a.fire(j,"ajax:before")){n=j.data("cross-domain");g=n===d?null:n;h=j.data("with-credentials")||null;m=j.data("type")||(b.ajaxSettings&&b.ajaxSettings.dataType);if(j.is("form")){e=j.attr("method");f=j.attr("action");i=j.serializeArray();var l=j.data("ujs:submit-button");if(l){i.push(l);j.data("ujs:submit-button",null)}}else{if(j.is(a.inputChangeSelector)){e=j.data("method");f=j.data("url");i=j.serialize();if(j.data("params")){i=i+"&"+j.data("params")}}else{if(j.is(a.buttonClickSelector)){e=j.data("method")||"get";f=j.data("url");i=j.serialize();if(j.data("params")){i=i+"&"+j.data("params")}}else{e=j.data("method");f=a.href(j);i=j.data("params")||null}}}o={type:e||"GET",data:i,dataType:m,beforeSend:function(q,p){if(p.dataType===d){q.setRequestHeader("accept","*/*;q=0.5, "+p.accepts.script)}if(a.fire(j,"ajax:beforeSend",[q,p])){j.trigger("ajax:send",q)}else{return false}},success:function(q,p,r){j.trigger("ajax:success",[q,p,r])},complete:function(q,p){j.trigger("ajax:complete",[q,p])},error:function(r,p,q){j.trigger("ajax:error",[r,p,q])},crossDomain:g};if(h){o.xhrFields={withCredentials:h}}if(f){o.url=f}return a.ajax(o)}else{return false}},handleMethod:function(j){var g=a.href(j),m=j.data("method"),l=j.attr("target"),e=b("meta[name=csrf-token]").attr("content"),h=b("meta[name=csrf-param]").attr("content"),i=b('<form method="post" action="'+g+'"></form>'),f='<input name="_method" value="'+m+'" type="hidden" />';if(h!==d&&e!==d){f+='<input name="'+h+'" value="'+e+'" type="hidden" />'}if(l){i.attr("target",l)}i.hide().append(f).appendTo("body");i.submit()},disableFormElements:function(e){e.find(a.disableSelector).each(function(){var f=b(this),g=f.is("button")?"html":"val";f.data("ujs:enable-with",f[g]());f[g](f.data("disable-with"));f.prop("disabled",true)})},enableFormElements:function(e){e.find(a.enableSelector).each(function(){var f=b(this),g=f.is("button")?"html":"val";if(f.data("ujs:enable-with")){f[g](f.data("ujs:enable-with"))}f.prop("disabled",false)})},allowAction:function(e){var f=e.data("confirm"),g=false,h;if(!f){return true}if(a.fire(e,"confirm")){g=a.confirm(f);h=a.fire(e,"confirm:complete",[g])}return g&&h},blankInputs:function(l,h,j){var g=b(),i,f,e=h||"input,textarea",m=l.find(e);m.each(function(){i=b(this);f=i.is("input[type=checkbox],input[type=radio]")?i.is(":checked"):i.val();if(!f===!j){if(i.is("input[type=radio]")&&m.filter('input[type=radio]:checked[name="'+i.attr("name")+'"]').length){return true}g=g.add(i)}});return g.length?g:false},nonBlankInputs:function(f,e){return a.blankInputs(f,e,true)},stopEverything:function(f){b(f.target).trigger("ujs:everythingStopped");f.stopImmediatePropagation();return false},disableElement:function(e){e.data("ujs:enable-with",e.html());e.html(e.data("disable-with"));e.bind("click.railsDisable",function(f){return a.stopEverything(f)})},enableElement:function(e){if(e.data("ujs:enable-with")!==d){e.html(e.data("ujs:enable-with"));e.removeData("ujs:enable-with")}e.unbind("click.railsDisable")}};if(a.fire(c,"rails:attachBindings")){b.ajaxPrefilter(function(e,g,f){if(!e.crossDomain){a.CSRFProtection(f)}});c.delegate(a.linkDisableSelector,"ajax:complete",function(){a.enableElement(b(this))});c.delegate(a.linkClickSelector,"click.rails",function(j){var h=b(this),l=h.data("method"),i=h.data("params"),g=j.metaKey||j.ctrlKey;if(!a.allowAction(h)){return a.stopEverything(j)}if(!g&&h.is(a.linkDisableSelector)){a.disableElement(h)}if(h.data("remote")!==d){if(g&&(!l||l==="GET")&&!i){return true}var f=a.handleRemote(h);if(f===false){a.enableElement(h)}else{f.error(function(){a.enableElement(h)})}return false}else{if(h.data("method")){a.handleMethod(h);return false}}});c.delegate(a.buttonClickSelector,"click.rails",function(g){var f=b(this);if(!a.allowAction(f)){return a.stopEverything(g)}a.handleRemote(f);return false});c.delegate(a.inputChangeSelector,"change.rails",function(g){var f=b(this);if(!a.allowAction(f)){return a.stopEverything(g)}a.handleRemote(f);return false});c.delegate(a.formSubmitSelector,"submit.rails",function(l){var h=b(this),j=h.data("remote")!==d,g,f;if(!a.allowAction(h)){return a.stopEverything(l)}if(h.attr("novalidate")==d){g=a.blankInputs(h,a.requiredInputSelector);if(g&&a.fire(h,"ajax:aborted:required",[g])){return a.stopEverything(l)}}if(j){f=a.nonBlankInputs(h,a.fileInputSelector);if(f){setTimeout(function(){a.disableFormElements(h)},13);var i=a.fire(h,"ajax:aborted:file",[f]);if(!i){setTimeout(function(){a.enableFormElements(h)},13)}return i}a.handleRemote(h);return false}else{setTimeout(function(){a.disableFormElements(h)},13)}});c.delegate(a.formInputClickSelector,"click.rails",function(g){var f=b(this);if(!a.allowAction(f)){return a.stopEverything(g)}var e=f.attr("name"),h=e?{name:e,value:f.val()}:null;f.closest("form").data("ujs:submit-button",h)});c.delegate(a.formSubmitSelector,"ajax:send.rails",function(e){if(this==e.target){a.disableFormElements(b(this))}});c.delegate(a.formSubmitSelector,"ajax:complete.rails",function(e){if(this==e.target){a.enableFormElements(b(this))}});b(function(){a.refreshCSRFTokens()})}})(jQuery);var Chorus=Chorus||{};Chorus.DynamicSizedImages=function(d){var b={};d(document).ready(function(){Chorus.DynamicSizedImages.init()});var f=".vox-lazy-load";var a="lazy-loaded";var e="lazy-loading";function c(g,j){var h={failure_limit:20,load:function(){var p=d(this),n=p.parent(".image-window");if(p.is("img")){if(n.length>0){p.css({position:"absolute",top:Math.round((n.outerHeight()-p.outerHeight())/2),left:Math.round((n.outerWidth()-p.outerWidth())/2)});if(typeof p.attr("height")==="undefined"){p.css("height","auto")}}else{p.css("height","auto")}}p.addClass(a);p.removeClass(e);if(d.fn.playGIF){var o={};if(Chorus.Context&&Chorus.Context.main_link_color){o.circleBackgroundColor=Chorus.Context.main_link_color;o.circleTextColor="FFFFFF"}if(typeof PLAYGIF_DISABLE_FLAG==="undefined"){var m=d('.m-entry__body img[src*=".gif"], .m-block__fanshot-media img[src*=".gif"]');var q=d('.m-entry__top-hero .m-entry__photo img[data-original*=".gif"]');if((m.length+q.length)===1){PLAYGIF_DISABLE_FLAG=true}else{PLAYGIF_DISABLE_FLAG=false;m.playGIF(o)}}p.playGIF(o)}},threshold:800};if(j){d.extend(h,j)}var g=g||d("body");var i=g.find(f+":visible").not("."+e,"."+a);var l=[];i.each(function(t,o){var q=d(this);var r=q.data("imgkey");if(typeof r!=="undefined"){var m=q.outerWidth();var u=q.outerHeight();if(q.is("img")){var p=q.data("ratio"),s=q.parent(".image-window");if(typeof p!=="undefined"&&p>0){u=Math.ceil(m/p)}if(s.length>0){m=Math.ceil(s.outerWidth());u=Math.ceil(s.outerHeight())}if(u>0){q.css("height",u)}}if(typeof window.devicePixelRatio!=="undefined"){m=Math.ceil(m*window.devicePixelRatio);u=Math.ceil(u*window.devicePixelRatio)}var n=r+":"+m+"x"+u;l.push(n);q.attr("data-dim",m+"x"+u);q.addClass(e)}else{q.lazyload(h)}});if(l.length==0){return}l.sort(function(n,m){return +n.split(":")[0]-+m.split(":")[0]});d.ajax({type:"GET",url:"/chorus_page/optimally_sized_images",dataType:"json",contentType:"application/json",data:{imgkeys:l.join(",")},success:function(m){var n=m.urls;i.each(function(){var q=d(this);var p=q.data("imgkey")+":"+q.data("dim");var o=n[p];if(typeof o!=="undefined"){q.attr("data-original",o);q.lazyload(h)}})}})}b.init=function(){this.initUI();if(Chorus.EventDispatcher){Chorus.EventDispatcher.subscribe("moduleInserted",function(g){c(g.modules)})}};b.initUI=function(g,h){c(g,h)};b.applyTo=function(g,h){c(g,h)};return b}(jQuery);var Chorus=Chorus||{};Chorus.EditoriallyManagedCell=(function(c,h){var g={edit:"/editorially_managed_cells/handle_edit",update:"/editorially_managed_cells/handle_update",preview:"/editorially_managed_cells/preview",show_live:"/editorially_managed_cells/refresh",help:"/editorially_managed_cells/help"};var d=null;function a(p){var q={};var m=p.serializeArray();for(var n=m.length-1;n>-1;n--){q[m[n].name]=m[n].value}return q}function e(m){alert("there was an error with the Editorially Managed Cell : "+m.statusText)}function b(m){m.preventDefault();var n=c(m.currentTarget);f(n.closest(".chorus-emc__admin"),n.data("emc-action"))}function i(n){n.preventDefault();var o=c(n.currentTarget);var m=o.closest("form");f(c('.chorus-emc__admin[data-emc-slug="'+m.data("emc-slug")+'"]'),"update",_.extend(a(m),{button_action:o.data("emc-action")}))}function f(m,o,q){var q=_.extend({slug:m.data("emc-slug"),bucket:m.data("emc-bucket")},q);var p=g[o];q;if(o==="edit"||o==="help"){Chorus.EventDispatcher.publish("modal_open",{method:n,url:p,data:q})}else{var n=(o=="update")?"POST":"GET";j(m);c.ajax({method:n,url:p,data:q,success:function(s){Chorus.EventDispatcher.publish("modal_close");var r=c('.chorus-emc__content[data-emc-slug="'+m.data("emc-slug")+'"]');if(r.length>0){r.replaceWith(s)}},error:e})}}function j(m){c(m).find(".chorus-emc__content").html("Loading...")}function l(){c(h).on("click",".chorus-emc__admin *[data-emc-action]",b);c(h).on("click",".chorus-emc__form *[data-emc-action]",i)}return{init:l,urls:g}})(jQuery,document);jQuery(function(){Chorus.EditoriallyManagedCell.init()});Chorus.ModuleLoader=(function(d){var b={};d(document).ready(function(){Chorus.ModuleLoader.init()});var a=function(e){d.ajax({type:"GET",url:"/chorus_page/delayed_load_cells",dataType:"json",contentType:"application/json",data:e,success:function(f){if(f===null){return}d.each(f,function(j,i){var h=d(d.parseHTML(i,document,true));var g=h.data("sbn-module-name");d("#"+j).replaceWith(h);if(Chorus.EventDispatcher){Chorus.EventDispatcher.publish("moduleInserted",{modules:h});if(g&&SBN[g]){SBN[g].init()}}})}})};var c=function(q){q=q||d(document);var h=[];var f=Util.UserAgentProfiler.profile();q.find("[data-delayed-load-cell-key]").each(function(){var i=d(this);if(i.data("unless-profile-is")!==f){h.push(i.data("delayed-load-cell-key"))}});if(h.length==0){return}h.sort();var g=2000,m=0,l=[];for(var j=0,o=h.length;j<o;j++){var p=h[j],e=p.length;if((m+e)>=g){var n={cells:JSON.stringify(l)};if(Chorus.Context.hub_id){n.hub_id=Chorus.Context.hub_id}a(n);l=[p];m=0}else{m+=e;l.push(p)}if((j+1)==o){var n={cells:JSON.stringify(l)};if(Chorus.Context.hub_id){n.hub_id=Chorus.Context.hub_id}a(n)}}};b.init=function(){this.initUI()};b.initUI=function(){c()};return b})(jQuery);var Chorus=Chorus||{};Chorus.ToggleLink=(function(c){var b="a[data-toggle-url]";function a(){var d=c(this);var e=d.data();if(e.toggleInProcess){return false}if(e.toggleText){oldText=d.text();d.text(e.toggleText)}e.toggleInProcess=true;c.ajax({url:d.attr("href"),type:e.toggleMethod||"POST",dataType:"text",success:function(){e.toggleText=oldText;if(e.toggleUrl){var f=e.toggleUrl;d.attr("href",e.toggleUrl);e.toggleUrl=f}e.toggleInProcess=false},error:function(){d.text(oldText);e.toggleInProcess=false;alert("An unknown error occurred. Please try again later.")}});return false}return{init:function(){c(document).on("click",b,a)}}})(jQuery);jQuery(function(){Chorus.ToggleLink.init()});var Chorus=Chorus||{};Chorus.LinkShare=(function(e){var g="http://www.facebook.com/share.php?u=",i="http://twitter.com/share?url=",d="https://plus.google.com/share?url=";var c=e(window);function h(l){var m=575,j=400,p=(c.width()-m)/2,o=(c.height()-j)/2,n="status=1,width="+m+",height="+j+",top="+o+",left="+p;window.open(l,"twitter",n)}function b(j){h(g+j)}function f(j){h(i+j)}function a(j){h(d+j)}return{share:function(l,j){if(j==="twitter"){f(l)}if(j==="facebook"){b(l)}if(j==="gplus"){a(l)}}}})(jQuery);var Vox=Vox||{};Vox.StreamEntryLinks=(function(d){var e=d(window);function c(f){f.preventDefault();Chorus.LinkShare.share(f.currentTarget.getAttribute("data-url"),"facebook")}function a(f){f.preventDefault();Chorus.LinkShare.share(f.currentTarget.getAttribute("data-url"),"twitter")}function b(f){f.preventDefault();Chorus.LinkShare.share(f.currentTarget.getAttribute("data-url"),"gplus")}return{init:function(){d(".m-stream__update__meta-facebook").on("click",c);d(".m-stream__update__meta-twitter").on("click",a);d(".m-stream__update__meta-gplus").on("click",b)}}})(jQuery);jQuery(function(){Vox.StreamEntryLinks.init()});var Chorus=Chorus||{};Chorus.EntryResponsiveVideo=(function(f){var h=".m-entry__body";var e=['iframe[src*="youtube.com"]','iframe[src*="instagram.com"]','iframe[src*="ooyala.com"]'].join(",");var d=["div[id*=ooyalaPlayer]",".m-video__pane iframe",".mceItemFlash",".m-block__fanshot-media.video iframe",".m-block__fanshot-media.video object",".sbn-body-feature .sbn-feature-entry .feature-body iframe"].join(",");function b(){g(f(h));f(d).each(c)}function g(i){i.find(e).each(c)}function c(){var i="";$this=f(this);if($this.hasClass("no-responsive-video")||$this.parents(".no-responsive-video").length){return true}else{if(/instagram\.com/.test($this.attr("src"))){i=" instagram"}}$this.find("object, embed, video").attr("width","100%").attr("height","100%");$this.find("div.OoyalaHtml5VideoPlayer").css({width:"100%",height:"100%"});$this.removeAttr("width").removeAttr("height").wrap('<div class="p-scalable-video'+i+'"></div>');return true}function a(j){var i=setTimeout(function(){j();clearTimeout(i)},1000)}return{wrapVideosInEntryBody:function(i){a(function(){g(i)})},init:function(){a(b)}}})(jQuery);jQuery(function(){Chorus.EntryResponsiveVideo.init()});Vox=Vox||{};Vox.ShareSelectionContextual=(function(d){var a=d(window);var f="";function h(){sel=window.getSelection();if(sel.rangeCount){range=sel.getRangeAt(0).cloneRange();if(range.getClientRects){var j=range.getClientRects();var l=j[j.length-1];if(l){return{x:l.right+a.scrollLeft()+5,y:l.top+a.scrollTop()+5}}}}return null}function c(l){var j=d(".m-share_selection_contextual");if(j.length<1){if(window.getSelection().toString().length>117){j=d('<div class="m-share_selection_contextual"><li class="m-share_selection_contextual__twitter twitter"><span class="m-share_selection_contextual__twitter__count overflow">'+window.getSelection().toString().length+'</span><span class="m-share_selection_contextual__label">Tweet<span></li><li class="m-share_selection_contextual__facebook facebook"><span class="m-share_selection_contextual__label">Share</span></li></ul></div>')}else{j=d('<div class="m-share_selection_contextual"><li class="m-share_selection_contextual__twitter twitter"><span class="m-share_selection_contextual__twitter__count">'+window.getSelection().toString().length+'</span><span class="m-share_selection_contextual__label">Tweet<span></li><li class="m-share_selection_contextual__facebook facebook"><span class="m-share_selection_contextual__label">Share</span></li></ul></div>')}}j.css({top:(l.y-d("#article-body").offset().top)+"px"});d("#article-body").append(j)}function g(){d(".m-share_selection_contextual").remove()}function e(l){if(l==="facebook"){var n=Chorus.Context.short_url;if(!n){n=window.location.href}FB.ui({method:"feed",link:n,caption:f},function(q){})}if(l==="twitter"){var p="https://twitter.com/intent/tweet?text="+f;var o="scrollbars=yes,resizable=yes,toolbar=no,location=yes",m=550,j=420;if(Chorus.Context.short_url){p=p+"&url="+Chorus.Context.short_url}if(Chorus.Context.community_twitter_screen_name){p=p+"&via="+Chorus.Context.community_twitter_screen_name}window.open(p,"intent",o+",width="+m+",height="+j)}}function i(j){_.delay(function(){f=window.getSelection().toString();var l=h();if(f.length<1||l==null){g()}else{c(l)}},100)}function b(l){l.preventDefault();var m=d(l.currentTarget);var j=(m.hasClass("twitter"))?"twitter":(m.hasClass("facebook"))?"facebook":null;g();e(j);ga("send","event","Social","Article Share Highlight Text","Article Share Highlight Text "+j)}return{init:function(){if(window.getSelection&&Chorus.Context.select_to_tweet!==false){d(".m-entry__intro, .m-entry__body").on("mouseup",i);d("body").on("click",".m-share_selection_contextual li",b)}}}})(jQuery);jQuery(function(){Vox.ShareSelectionContextual.init()});var Vox=Vox||{};Vox.GlobalHeader=(function(e){var d={};var b="#global-header__tab";var c=".m-global-header__user-items";var a="usernav-active";d.init=function(){e(b).on("click",function(){e(c).toggleClass(a)})};return d})(jQuery);jQuery(function(){Vox.GlobalHeader.init()});var Vox=Vox||{};Vox.FollowBar=(function(b){var a={};a.init=function(){b(document).on("click","#close-follow-bar",function(c){c.preventDefault();b("#follow-bar").slideUp();b.cookie("closed_follow_bar","true",{expires:365,path:"/"})})};return a})(jQuery);jQuery(function(){Vox.FollowBar.init()});var Vox=Vox||{};Vox.UserProfile=(function(a){return{init:function(){var b=a(".m-profile");if(b.length<1){return}this.config(function(){Vox.UserProfile.activityToggle.on("click","a",Vox.UserProfile.toggleActivity);Vox.UserProfile.adminLinkToggle.on("change",Vox.UserProfile.gotoAdminLink);Vox.UserProfile.coloredRows(Vox.UserProfile.activityTableClass,"tr");Vox.UserProfile.activityToggle.find("a:first").trigger("click")})},config:function(b){this.activityToggle=a("#filter-pane-toggle");this.profileRail=a(".m-filter-pane__rail");this.profileRiver=a(".m-filter-pane__content");this.activityTable=a(".m-profile__activity-table");this.activityTableClass=".m-profile__activity-table";this.adminLinkToggle=a("#profile-meta-link-toggle");this.selectedClass="is-selected";this.disabledClass="is-disabled";this.favoriteClass="is-favorite";this.oddClass="odd";b()},gotoAdminLink:function(c){var b=a(this).val();if(b!==""){window.location=b}},toggleActivity:function(){if(!a(this).parent().hasClass(Vox.UserProfile.disabledClass)){var d=a(this).data("type");if(!_.isUndefined(d)){var b=Vox.UserProfile.activityTable.length;var e=b?Vox.UserProfile.activityTable.find("tr"):Vox.UserProfile.profileRiver.find(".m-block");var c=a(this).parents(Vox.UserProfile.activityToggle.selector).find("li");c.removeClass(Vox.UserProfile.selectedClass);a(this).parent().addClass(Vox.UserProfile.selectedClass);if(b){e.removeClass(Vox.UserProfile.oddClass)}e.hide();if(d==="all"){e.show()}else{e.filter("."+d+", ."+d.toLowerCase()).show()}if(b){Vox.UserProfile.coloredRows(Vox.UserProfile.activityTableClass,"tr")}return false}}else{return false}},coloredRows:function(b,c){a(b).find(c).filter(":visible").each(function(d,f){if(d%2){a(this).addClass("odd")}})}}})(jQuery);jQuery(function(){Vox.UserProfile.init()});jQuery(function(b){var a=[];var c="38,38,40,40,37,39,37,39,66,65";b(document).keydown(function(d){a.push(d.keyCode);if((a.toString().indexOf(c)>=0)){a=[];location.href="/cards/super-super-super-secret-easter-eggs/whats-an-easter-egg#5351903"}else{if(a.length>20){a=[]}}})});var Vox=Vox||{};Vox.Toggle=(function(b){var a=window.location.hash.slice(1),h=b("toggles"),i;if(h.length>0){var d=h.html().split(",")}var e=function(){h.addClass("clearfix");h.empty();d.forEach(function(j){h.append('<a href="javascript:void(0);" mce_href="javascript:void(0);" data-name="'+j+'">'+j+"</a>");var l=b.inArray(j,d);var m=d.length-1;if(l===m){l=0}else{l=l+1}b(j).append('<p><em><a class="toggle-bottom" data-name="'+d[l]+'" href="javascript:void(0);" mce_href="javascript:void(0);">Read the '+d[l]+"</a></em></p> ")})};var f=function(){if(a){var l=b("toggles a[data-name='"+a+"']");l.addClass("toggle-selected");var j=b.inArray(a,d);d.splice(j,1);d.forEach(function(m){b(m).hide()})}else{b("toggles a:first-child").addClass("toggle-selected");d.splice(0,1);d.forEach(function(m){b(m).hide()})}};var c=function(){var j=b(this).data("name");if(i){ga("send","event","Story/Interview Toggle",j)}window.location.hash=j;if(b(this).attr("class")=="toggle-bottom"){b("body").animate({scrollTop:b("toggles").offset().top},0)}b("toggles a").removeClass("toggle-selected");b('toggles a[data-name="'+j+'"]').addClass("toggle-selected");var l=b("toggles a").each(function(n){var m=b(this).data("name");b(m).hide()});b(j).show()};var g=function(){if(h.length>0){if(typeof ga==="function"){i=true}var j=h.html().split(",");e();f();b("toggles a, .toggle-bottom").on("click",c)}};g()})(jQuery);
/*! Hammer.JS - v1.0.6 - 2014-01-02
 * http://eightmedia.github.com/hammer.js
 *
 * Copyright (c) 2014 Jorik Tangelder <j.tangelder@gmail.com>;
 * Licensed under the MIT license */
(function(C,j){var x=function(N,M){return new x.Instance(N,M||{})};x.defaults={stop_browser_behavior:{userSelect:"none",touchAction:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};x.HAS_POINTEREVENTS=C.navigator.pointerEnabled||C.navigator.msPointerEnabled;x.HAS_TOUCHEVENTS=("ontouchstart" in C);x.MOBILE_REGEX=/mobile|tablet|ip(ad|hone|od)|android|silk/i;x.NO_MOUSEEVENTS=x.HAS_TOUCHEVENTS&&C.navigator.userAgent.match(x.MOBILE_REGEX);x.EVENT_TYPES={};x.DIRECTION_DOWN="down";x.DIRECTION_LEFT="left";x.DIRECTION_UP="up";x.DIRECTION_RIGHT="right";x.POINTER_MOUSE="mouse";x.POINTER_TOUCH="touch";x.POINTER_PEN="pen";x.EVENT_START="start";x.EVENT_MOVE="move";x.EVENT_END="end";x.DOCUMENT=C.document;x.plugins=x.plugins||{};x.gestures=x.gestures||{};x.READY=false;function e(){if(x.READY){return}x.event.determineEventTypes();x.utils.each(x.gestures,function(M){x.detection.register(M)});x.event.onTouch(x.DOCUMENT,x.EVENT_MOVE,x.detection.detect);x.event.onTouch(x.DOCUMENT,x.EVENT_END,x.detection.detect);x.READY=true}x.utils={extend:function i(M,O,P){for(var N in O){if(M[N]!==j&&P){continue}M[N]=O[N]}return M},each:function(Q,O,N){var M,P;if("forEach" in Q){Q.forEach(O,N)}else{if(Q.length!==j){for(M=0,P=Q.length;M<P;M++){if(O.call(N,Q[M],M,Q)===false){return}}}else{for(M in Q){if(Q.hasOwnProperty(M)&&O.call(N,Q[M],M,Q)===false){return}}}}},hasParent:function(N,M){while(N){if(N==M){return true}N=N.parentNode}return false},getCenter:function y(N){var O=[],M=[];x.utils.each(N,function(P){O.push(typeof P.clientX!=="undefined"?P.clientX:P.pageX);M.push(typeof P.clientY!=="undefined"?P.clientY:P.pageY)});return{pageX:((Math.min.apply(Math,O)+Math.max.apply(Math,O))/2),pageY:((Math.min.apply(Math,M)+Math.max.apply(Math,M))/2)}},getVelocity:function a(M,O,N){return{x:Math.abs(O/M)||0,y:Math.abs(N/M)||0}},getAngle:function o(O,N){var P=N.pageY-O.pageY,M=N.pageX-O.pageX;return Math.atan2(P,M)*180/Math.PI},getDirection:function l(O,N){var M=Math.abs(O.pageX-N.pageX),P=Math.abs(O.pageY-N.pageY);if(M>=P){return O.pageX-N.pageX>0?x.DIRECTION_LEFT:x.DIRECTION_RIGHT}else{return O.pageY-N.pageY>0?x.DIRECTION_UP:x.DIRECTION_DOWN}},getDistance:function n(O,N){var M=N.pageX-O.pageX,P=N.pageY-O.pageY;return Math.sqrt((M*M)+(P*P))},getScale:function w(N,M){if(N.length>=2&&M.length>=2){return this.getDistance(M[0],M[1])/this.getDistance(N[0],N[1])}return 1},getRotation:function u(N,M){if(N.length>=2&&M.length>=2){return this.getAngle(M[1],M[0])-this.getAngle(N[1],N[0])}return 0},isVertical:function B(M){return(M==x.DIRECTION_UP||M==x.DIRECTION_DOWN)},stopDefaultBrowserBehavior:function c(N,M){if(!M||!N||!N.style){return}x.utils.each(["webkit","khtml","moz","Moz","ms","o",""],function(O){x.utils.each(M,function(P){if(O){P=O+P.substring(0,1).toUpperCase()+P.substring(1)}if(P in N.style){N.style[P]=P}})});if(M.userSelect=="none"){N.onselectstart=function(){return false}}if(M.userDrag=="none"){N.ondragstart=function(){return false}}}};x.Instance=function(O,N){var M=this;e();this.element=O;this.enabled=true;this.options=x.utils.extend(x.utils.extend({},x.defaults),N||{});if(this.options.stop_browser_behavior){x.utils.stopDefaultBrowserBehavior(this.element,this.options.stop_browser_behavior)}x.event.onTouch(O,x.EVENT_START,function(P){if(M.enabled){x.detection.startDetect(M,P)}});return this};x.Instance.prototype={on:function D(M,N){var O=M.split(" ");x.utils.each(O,function(P){this.element.addEventListener(P,N,false)},this);return this},off:function p(M,N){var O=M.split(" ");x.utils.each(O,function(P){this.element.removeEventListener(P,N,false)},this);return this},trigger:function H(N,P){if(!P){P={}}var O=x.DOCUMENT.createEvent("Event");O.initEvent(N,true,true);O.gesture=P;var M=this.element;if(x.utils.hasParent(P.target,M)){M=P.target}M.dispatchEvent(O);return this},enable:function d(M){this.enabled=M;return this}};var G=null;var m=false;var h=false;x.event={bindDom:function(N,P,O){var M=P.split(" ");x.utils.each(M,function(Q){N.addEventListener(Q,O,false)})},onTouch:function A(O,N,P){var M=this;this.bindDom(O,x.EVENT_TYPES[N],function Q(S){var T=S.type.toLowerCase();if(T.match(/mouse/)&&h){return}else{if(T.match(/touch/)||T.match(/pointerdown/)||(T.match(/mouse/)&&S.which===1)){m=true}else{if(T.match(/mouse/)&&!S.which){m=false}}}if(T.match(/touch|pointer/)){h=true}var R=0;if(m){if(x.HAS_POINTEREVENTS&&N!=x.EVENT_END){R=x.PointerEvent.updatePointer(N,S)}else{if(T.match(/touch/)){R=S.touches.length}else{if(!h){R=T.match(/up/)?0:1}}}if(R>0&&N==x.EVENT_END){N=x.EVENT_MOVE}else{if(!R){N=x.EVENT_END}}if(R||G===null){G=S}P.call(x.detection,M.collectEventData(O,N,M.getTouchList(G,N),S));if(x.HAS_POINTEREVENTS&&N==x.EVENT_END){R=x.PointerEvent.updatePointer(N,S)}}if(!R){G=null;m=false;h=false;x.PointerEvent.reset()}})},determineEventTypes:function F(){var M;if(x.HAS_POINTEREVENTS){M=x.PointerEvent.getEvents()}else{if(x.NO_MOUSEEVENTS){M=["touchstart","touchmove","touchend touchcancel"]}else{M=["touchstart mousedown","touchmove mousemove","touchend touchcancel mouseup"]}}x.EVENT_TYPES[x.EVENT_START]=M[0];x.EVENT_TYPES[x.EVENT_MOVE]=M[1];x.EVENT_TYPES[x.EVENT_END]=M[2]},getTouchList:function t(M){if(x.HAS_POINTEREVENTS){return x.PointerEvent.getTouchList()}else{if(M.touches){return M.touches}else{M.identifier=1;return[M]}}},collectEventData:function K(O,N,Q,P){var M=x.POINTER_TOUCH;if(P.type.match(/mouse/)||x.PointerEvent.matchType(x.POINTER_MOUSE,P)){M=x.POINTER_MOUSE}return{center:x.utils.getCenter(Q),timeStamp:new Date().getTime(),target:P.target,touches:Q,eventType:N,pointerType:M,srcEvent:P,preventDefault:function(){if(this.srcEvent.preventManipulation){this.srcEvent.preventManipulation()}if(this.srcEvent.preventDefault){this.srcEvent.preventDefault()}},stopPropagation:function(){this.srcEvent.stopPropagation()},stopDetect:function(){return x.detection.stopDetect()}}}};x.PointerEvent={pointers:{},getTouchList:function(){var M=this;var N=[];x.utils.each(M.pointers,function(O){N.push(O)});return N},updatePointer:function(N,M){if(N==x.EVENT_END){this.pointers={}}else{M.identifier=M.pointerId;this.pointers[M.pointerId]=M}return Object.keys(this.pointers).length},matchType:function(M,O){if(!O.pointerType){return false}var P=O.pointerType,N={};N[x.POINTER_MOUSE]=(P===O.MSPOINTER_TYPE_MOUSE||P===x.POINTER_MOUSE);N[x.POINTER_TOUCH]=(P===O.MSPOINTER_TYPE_TOUCH||P===x.POINTER_TOUCH);N[x.POINTER_PEN]=(P===O.MSPOINTER_TYPE_PEN||P===x.POINTER_PEN);return N[M]},getEvents:function(){return["pointerdown MSPointerDown","pointermove MSPointerMove","pointerup pointercancel MSPointerUp MSPointerCancel"]},reset:function(){this.pointers={}}};x.detection={gestures:[],current:null,previous:null,stopped:false,startDetect:function z(N,M){if(this.current){return}this.stopped=false;this.current={inst:N,startEvent:x.utils.extend({},M),lastEvent:false,name:""};this.detect(M)},detect:function r(M){if(!this.current||this.stopped){return}M=this.extendEventData(M);var N=this.current.inst.options;x.utils.each(this.gestures,function(O){if(!this.stopped&&N[O.name]!==false){if(O.handler.call(O,M,this.current.inst)===false){this.stopDetect();return false}}},this);if(this.current){this.current.lastEvent=M}if(M.eventType==x.EVENT_END&&!M.touches.length-1){this.stopDetect()}return M},stopDetect:function b(){this.previous=x.utils.extend({},this.current);this.current=null;this.stopped=true},extendEventData:function v(P){var Q=this.current.startEvent;if(Q&&(P.touches.length!=Q.touches.length||P.touches===Q.touches)){Q.touches=[];x.utils.each(P.touches,function(U){Q.touches.push(x.utils.extend({},U))})}var N=P.timeStamp-Q.timeStamp,T=P.center.pageX-Q.center.pageX,S=P.center.pageY-Q.center.pageY,O=x.utils.getVelocity(N,T,S),R,M;if(P.eventType==="end"){R=this.current.lastEvent&&this.current.lastEvent.interimAngle;M=this.current.lastEvent&&this.current.lastEvent.interimDirection}else{R=this.current.lastEvent&&x.utils.getAngle(this.current.lastEvent.center,P.center);M=this.current.lastEvent&&x.utils.getDirection(this.current.lastEvent.center,P.center)}x.utils.extend(P,{deltaTime:N,deltaX:T,deltaY:S,velocityX:O.x,velocityY:O.y,distance:x.utils.getDistance(Q.center,P.center),angle:x.utils.getAngle(Q.center,P.center),interimAngle:R,direction:x.utils.getDirection(Q.center,P.center),interimDirection:M,scale:x.utils.getScale(Q.touches,P.touches),rotation:x.utils.getRotation(Q.touches,P.touches),startEvent:Q});return P},register:function f(N){var M=N.defaults||{};if(M[N.name]===j){M[N.name]=true}x.utils.extend(x.defaults,M,true);N.index=N.index||1000;this.gestures.push(N);this.gestures.sort(function(P,O){if(P.index<O.index){return -1}if(P.index>O.index){return 1}return 0});return this.gestures}};x.gestures.Drag={name:"drag",index:50,defaults:{drag_min_distance:10,correct_for_drag_min_distance:true,drag_max_touches:1,drag_block_horizontal:false,drag_block_vertical:false,drag_lock_to_axis:false,drag_lock_min_distance:25},triggered:false,handler:function s(N,O){if(x.detection.current.name!=this.name&&this.triggered){O.trigger(this.name+"end",N);this.triggered=false;return}if(O.options.drag_max_touches>0&&N.touches.length>O.options.drag_max_touches){return}switch(N.eventType){case x.EVENT_START:this.triggered=false;break;case x.EVENT_MOVE:if(N.distance<O.options.drag_min_distance&&x.detection.current.name!=this.name){return}if(x.detection.current.name!=this.name){x.detection.current.name=this.name;if(O.options.correct_for_drag_min_distance&&N.distance>0){var M=Math.abs(O.options.drag_min_distance/N.distance);x.detection.current.startEvent.center.pageX+=N.deltaX*M;x.detection.current.startEvent.center.pageY+=N.deltaY*M;N=x.detection.extendEventData(N)}}if(x.detection.current.lastEvent.drag_locked_to_axis||(O.options.drag_lock_to_axis&&O.options.drag_lock_min_distance<=N.distance)){N.drag_locked_to_axis=true}var P=x.detection.current.lastEvent.direction;if(N.drag_locked_to_axis&&P!==N.direction){if(x.utils.isVertical(P)){N.direction=(N.deltaY<0)?x.DIRECTION_UP:x.DIRECTION_DOWN}else{N.direction=(N.deltaX<0)?x.DIRECTION_LEFT:x.DIRECTION_RIGHT}}if(!this.triggered){O.trigger(this.name+"start",N);this.triggered=true}O.trigger(this.name,N);O.trigger(this.name+N.direction,N);if((O.options.drag_block_vertical&&x.utils.isVertical(N.direction))||(O.options.drag_block_horizontal&&!x.utils.isVertical(N.direction))){N.preventDefault()}break;case x.EVENT_END:if(this.triggered){O.trigger(this.name+"end",N)}this.triggered=false;break}}};x.gestures.Hold={name:"hold",index:10,defaults:{hold_timeout:500,hold_threshold:1},timer:null,handler:function J(M,N){switch(M.eventType){case x.EVENT_START:clearTimeout(this.timer);x.detection.current.name=this.name;this.timer=setTimeout(function(){if(x.detection.current.name=="hold"){N.trigger("hold",M)}},N.options.hold_timeout);break;case x.EVENT_MOVE:if(M.distance>N.options.hold_threshold){clearTimeout(this.timer)}break;case x.EVENT_END:clearTimeout(this.timer);break}}};x.gestures.Release={name:"release",index:Infinity,handler:function I(M,N){if(M.eventType==x.EVENT_END){N.trigger(this.name,M)}}};x.gestures.Swipe={name:"swipe",index:40,defaults:{swipe_min_touches:1,swipe_max_touches:1,swipe_velocity:0.7},handler:function L(M,N){if(M.eventType==x.EVENT_END){if(N.options.swipe_max_touches>0&&M.touches.length<N.options.swipe_min_touches&&M.touches.length>N.options.swipe_max_touches){return}if(M.velocityX>N.options.swipe_velocity||M.velocityY>N.options.swipe_velocity){N.trigger(this.name,M);N.trigger(this.name+M.direction,M)}}}};x.gestures.Tap={name:"tap",index:100,defaults:{tap_max_touchtime:250,tap_max_distance:10,tap_always:true,doubletap_distance:20,doubletap_interval:300},handler:function E(O,P){if(O.eventType==x.EVENT_END&&O.srcEvent.type!="touchcancel"){var N=x.detection.previous,M=false;if(O.deltaTime>P.options.tap_max_touchtime||O.distance>P.options.tap_max_distance){return}if(N&&N.name=="tap"&&(O.timeStamp-N.lastEvent.timeStamp)<P.options.doubletap_interval&&O.distance<P.options.doubletap_distance){P.trigger("doubletap",O);M=true}if(!M||P.options.tap_always){x.detection.current.name="tap";P.trigger(x.detection.current.name,O)}}}};x.gestures.Touch={name:"touch",index:-Infinity,defaults:{prevent_default:false,prevent_mouseevents:false},handler:function g(M,N){if(N.options.prevent_mouseevents&&M.pointerType==x.POINTER_MOUSE){M.stopDetect();return}if(N.options.prevent_default){M.preventDefault()}if(M.eventType==x.EVENT_START){N.trigger(this.name,M)}}};x.gestures.Transform={name:"transform",index:45,defaults:{transform_min_scale:0.01,transform_min_rotation:1,transform_always_block:false},triggered:false,handler:function q(O,P){if(x.detection.current.name!=this.name&&this.triggered){P.trigger(this.name+"end",O);this.triggered=false;return}if(O.touches.length<2){return}if(P.options.transform_always_block){O.preventDefault()}switch(O.eventType){case x.EVENT_START:this.triggered=false;break;case x.EVENT_MOVE:var N=Math.abs(1-O.scale);var M=Math.abs(O.rotation);if(N<P.options.transform_min_scale&&M<P.options.transform_min_rotation){return}x.detection.current.name=this.name;if(!this.triggered){P.trigger(this.name+"start",O);this.triggered=true}P.trigger(this.name,O);if(M>P.options.transform_min_rotation){P.trigger("rotate",O)}if(N>P.options.transform_min_scale){P.trigger("pinch",O);P.trigger("pinch"+((O.scale<1)?"in":"out"),O)}break;case x.EVENT_END:if(this.triggered){P.trigger(this.name+"end",O)}this.triggered=false;break}}};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define(function(){return x})}else{if(typeof module==="object"&&typeof module.exports==="object"){module.exports=x}else{C.Hammer=x}}})(this);var Vox=Vox||{};Vox.Explainers=_.extend({},Backbone.Events,{Views:{},initialize:function(){$("[data-explainer]").each(function(){Vox.Explainers.embed(this)})},embed:function(a){new Vox.Explainers.Views.Embed({el:a}).render()}});jQuery(function(){Vox.Explainers.initialize()});Vox.Explainers.Model=Backbone.Model.extend({initialize:function(a,b){this.cards=new Backbone.Collection(a.cards);this.cards.url=this.get("url");this.active_card=a.cards[a.active_index]},url:function(){return this.get("url")+".json"},parse:function(a){for(var b=a.cards.length;b--;){if(a.cards[b].id==this.active_card.id){a.cards[b]=this.active_card;break}}this.cards.set(a.cards,{remove:false});delete a.cards;return a}});Vox.Explainers.VideoUtil={loadVideos:function(b,a){if(a){Chorus.VideoContext.addVideos(a)}Chorus.Video.init({checkForExistingPlayer:true});Chorus.EntryResponsiveVideo.wrapVideosInEntryBody(b)}};Vox.Explainers.Views.Card=Backbone.View.extend({tagName:"li",className:"m-explainer__card",templateId:"explainers-card-template",initialize:function(){this.listenTo(this.model,"change",this.render)},attributes:function(){return{"data-id":this.model.id}},template:function(a){return _.template($("#"+this.templateId).html(),a)},render:function(){var a,c,b,d;if(_.isNumber(this.options.index)){a=this.options.index+1;c=this.model.collection.at(this.options.index-1);b=this.model.collection.at(this.options.index+1)}d=_.extend({prevUrl:c&&c.get("url"),nextUrl:b&&b.get("url"),shortUrl:encodeURIComponent(this.model.get("short_url")+window.location.hash),position:a,total:this.options.total},this.model.toJSON());if(d.url){d.url=encodeURIComponent(d.url+window.location.hash)}this.$el.html(this.template(d));this.$el.find(".m-explainer__card-content a[href^='http']").attr("target","_blank");return this}});Vox.Explainers.Views.Embed=Backbone.View.extend({events:{"click a":"onOpenClick"},initialize:function(){this.model=new Vox.Explainers.Model(this.$el.data("explainer"));this.originalTitle=document.title;this.originalUrl=window.location.href;this.originalHistoryPosition=window.history.length;$(window).on("popstate",_.bind(this.onPopstate,this))},template:function(a){return _.template($("#explainers-embed-template").html(),a)},render:function(){var a=this.activeCard();var b={title:this.model.get("title"),currentCard:this.model.get("active_index")+1,cardCount:this.model.cards.length,cardTitle:a.get("title"),cardBody:a.get("body"),userName:this.model.get("user").name,updatedAt:this.model.get("modified_date"),url:a.get("url")};this.$el.html(this.template(b));this.$(".video-wrap, .chorus-video-embed").remove();Vox.Explainers.VideoUtil.loadVideos(this.$el,a.get("chorus_videos"));this.trackCardStackLaunchers();return this},trackCardStackLaunchers:function(){var a=$(".m-explainer-embed__header a, .m-explainer-embed__main h4 a, .m-explainer-embed__footer a");a.on("click",{params:["Internal Card Stack Traffic","Article Card Stack Traffic","Article Card Stack Traffic Embedded Card"]},Util.uaTrackEvent)},openFullscreen:function(a){this.originalScrollTop=$(window).scrollTop();this.fullscreen=new Vox.Explainers.Views.Fullscreen({opener:this,model:this.model});this.fullscreen.render(a)},closeFullscreen:function(a){this.fullscreen=null;$("body, html").scrollTop(this.originalScrollTop);if(a&&Modernizr.history){window.history.go(this.originalHistoryPosition-window.history.length)}},activeCard:function(){return this.model.cards.at(this.model.get("active_index"))},onOpenClick:function(c){var a=$(c.currentTarget).attr("href");var b=$(c.currentTarget).parent();var d="";if(b.hasClass("m-explainer-embed__header")){d=" Header"}else{if(b.hasClass("m-explainer-embed__main")){d=" Main"}else{if(b.hasClass("m-explainer-embed__footer")){d=" Footer"}}}this.sendAnalytics("event",["Explainer Embed","Open Click"+d]);if(a==this.activeCard().get("url")){this.openFullscreen(true)}else{window.open(a,"_blank")}c.preventDefault()},onPopstate:function(b){var a=b.originalEvent.state;if(a&&a.explainerId===this.model.id&&!this.fullscreen){this.model.set("active_index",a.index);this.openFullscreen(false)}else{document.title=this.originalTitle}},sendAnalytics:function(a,d){if(!this.isPreview){try{var c=["send",a].concat(d);ga.apply(this,c)}catch(b){}}}});Vox.Explainers.Views.Fullscreen=Backbone.View.extend({className:"m-explainer",id:"explainer",templateId:"explainers-fullscreen-template",cardSlc:".m-explainer__card",cardsContainerSlc:".m-explainer__cards",pagerSlc:".m-explainer__pager__card-count",tocItemSlc:".m-explainer__toc",events:{"click .m-explainer__close":"onCloseClick","click .m-explainer__pager-control.next":"onNextClick","click .m-explainer__pager-control.previous":"onPrevClick","click .m-explainer__toc a":"onTocClick","click .m-explainer__card-content a":"onContentClick","click #mobile-rail-toggle":"toggleMobileRail","click #mobile-rail-overlay":"toggleMobileRail",keydown:"keyboardNavigation"},animationEndEvent:{WebkitAnimation:"webkitAnimationEnd",OAnimation:"oAnimationEnd",msAnimation:"MSAnimationEnd",animation:"animationend"}[Modernizr.prefixed("animation")],animationSupport:Modernizr.cssanimations,historySupport:Modernizr.history,isAnimating:false,isPreview:false,railOpen:false,adClass:"ad",adRequestEvent:"Hymnal.requestAd",adResponseEvent:"Vox.Ad.ResponseWithHTML",initialize:function(a){_.bindAll(this,"onPopstate","handleSwipes","configToc","onEndAnimation");this.cardModels=this.model.cards;this.cardViews=[];this.opener=a.opener;this.pageTitle=document.title;this.currentIndex=this.model.get("active_index")||0;this.hammertime=new Hammer(this.el,{drag_lock_to_axis:true,prevent_mouseevents:true,stop_browser_behavior:{userSelect:"text"}});this.hammertime.on("release dragleft dragright swipeleft swiperight",this.handleSwipes);this.isPreview=a.preview?true:false;this.fastclick=FastClick.attach(this.el);this.prefetchCards()},addCard:function(b,d,e){e=$.extend({},e);var c=new Backbone.Model({id:new Date().getTime(),body:b});var a=new Vox.Explainers.Views.Card({model:c,header:null});this.cardModels.add(c,{at:d});this.cardViews.splice(d,0,a);a.render();if(e.isAd){a.$el.addClass(this.adClass);e.$tocItem=$('<li class="ad">Advertisement</li>')}a.$el.insertBefore(this.$(this.cardSlc).eq(d));this.addTocItem(e.$tocItem,d)},removeCard:function(b){var d=this.$(this.cardSlc).index(b);var c=this.cardModels.at(d);var a=this.cardViews[d];if(this.currentIndex>=d){this.currentIndex-=1}a.remove();this.cardModels.remove(c);this.removeTocItem(d)},addTocItem:function(c,b){var a=this.$(this.tocItemSlc);$currentTocItem=a.children("li").eq(b);c.insertBefore($currentTocItem)},removeTocItem:function(b){var a=this.$(this.tocItemSlc);var c=a.children("li").eq(b);c.remove()},cardCount:function(){return this.cardModels.length},template:function(a){return _.template($("#"+this.templateId).html(),a)},render:function(b){var a=this.$el;a.html(this.template({title:this.model.get("title"),url:encodeURIComponent(this.model.get("url")+window.location.hash),exitUrl:this.exitUrl(),chorusImageId:this.model.get("chorus_image_id"),photoCredit:this.model.get("photo_credit"),photoCreditUrl:this.model.get("photo_credit_url"),userName:this.model.get("user").name,userUrl:this.model.get("user").url,updatedAt:this.model.get("modified_date"),currentCard:this.currentIndex+1,cards:this.cardModels.map(function(d){return{title:d.get("title"),url:d.get("url")}})}));this.cardViews=this.cardModels.map(function(e,d,f){var c=new Vox.Explainers.Views.Card({model:e,index:d,total:f.length});c.render();this.$(this.cardsContainerSlc).append(c.el);return c},this);$("body, html").scrollTop(0);$("body").addClass("explainer-opening");_.delay(_.bind(function(){$("body").addClass("explainer-open").removeClass("explainer-opening");this.updateTocCurrentItem()},this),500);a.appendTo("body");setTimeout(function(){a.addClass("loaded")},0);a.attr("tabIndex",-1).focus();if(this.model.get("chorus_image_id")&&(Util.UserAgentProfiler.isDesktop()||Util.UserAgentProfiler.isTablet())){this.applyBackgroundImage(a)}this.cardsSeen=0;this.configToc();this.gotoIndex(this.currentIndex,b,true);$(window).on("resize.explainer",_.bind(_.debounce(this.resizer,300),this));$(window).on("popstate.explainer",this.onPopstate);this.trackCardStackSocial();return this},applyBackgroundImage:function(b){var a=this.model.get("chorus_image_id")+":standard:1";b.attr("data-imgkey",a);b.addClass("vox-lazy-load");Chorus.DynamicSizedImages.applyTo()},resizer:function(){if(($(window).width()>880)&&this.railOpen){this.toggleMobileRail()}this.configToc()},configToc:function(){var b=$("#explainer-rail-list");var e=$("#explainer-rail-header");var d=$(".m-explainer__toc-scroller");var c=$(window);if(c.width()<880){$("#explainer-rail-list").removeAttr("style");return false}var a=$(window).height()-(300+e.offset().top+e.height()+(d.height()*2));a=(a>240)?a:240;$("#explainer-rail-list").height(a);d.on("click",function(g){var f=$(this).hasClass("down")?+a:-a;b.animate({scrollTop:b.scrollTop()+f-100},200);g.preventDefault()})},setContainerOffset:function(b,a){$(b).css("transform","translate("+a+"%,0)")},handleSwipes:function(c){var e=this.$(this.cardSlc).eq(this.currentIndex);var a=0.25;var d=0;var b=$(window).width();c.gesture.preventDefault();if(this.railOpen){return false}switch(c.type){case"dragright":case"dragleft":d=((100/b)*c.gesture.deltaX)/2;this.setContainerOffset(e,d);break;case"swipeleft":this.gotoNext(c);c.gesture.stopDetect();this.sendAnalytics("event",["Explainer Fullscreen","Next Swipe"]);break;case"swiperight":this.gotoPrev(c);c.gesture.stopDetect();this.sendAnalytics("event",["Explainer Fullscreen","Prev Swipe"]);break;case"release":if(Math.abs(c.gesture.deltaX)>(b*a)){if(c.gesture.direction==="right"){this.gotoPrev();this.sendAnalytics("event",["Explainer Fullscreen","Prev Swipe"])}else{this.gotoNext();this.sendAnalytics("event",["Explainer Fullscreen","Next Swipe"])}}else{this.setContainerOffset(e,0)}break}},updateTocCurrentItem:function(){var a=this.$(this.tocItemSlc);var d=a.children("li").eq(this.currentIndex);var b=d.prev();this.clearTocCurrentItem();d.addClass("current");var c=a.scrollTop();if(b.length>0){c+=b.position().top}a.animate({scrollTop:c},350)},clearTocCurrentItem:function(){var a=this.$(this.tocItemSlc);a.children("li").removeClass("current")},toggleMobileRail:function(f){var c=$("#explainer-rail");var b=$("#mobile-rail-toggle");var a=$("#mobile-rail-overlay");var d=this.$(this.cardSlc).eq(this.currentIndex);f&&f.preventDefault();b.toggleClass("open");a.toggleClass("open");c.toggleClass("open");if(c.hasClass("open")){this.railOpen=true}else{this.railOpen=false}},onNextClick:function(a){var b=$(a.currentTarget).closest(".m-explainer__pager").hasClass("lower")?"Lower":"Upper";this.sendAnalytics("event",["Explainer Fullscreen","Next Click "+b]);this.gotoNext();a.preventDefault()},onPrevClick:function(a){var b=$(a.currentTarget).closest(".m-explainer__pager").hasClass("lower")?"Lower":"Upper";this.sendAnalytics("event",["Explainer Fullscreen","Prev Click "+b]);this.gotoPrev();a.preventDefault()},onCloseClick:function(a){this.sendAnalytics("event",["Explainer Fullscreen","Close Click"]);this.close(true);a.preventDefault()},onContentClick:function(b){var a=this.cardModels.findWhere({url:$(b.currentTarget).attr("href")});if(a){this.gotoIndex(this.cardModels.indexOf(a),true,false,true);b.preventDefault()}},exitUrl:function(){if(this.opener){return"/e/"+Chorus.Context.entry_id}else{if(window.location.hash.match(/^#E[0-9]+$/)){return"/e/"+window.location.hash.substring(2)}else{if(document.referrer.indexOf("http://"+window.location.host)===0){return document.referrer}else{return"/"}}}},close:function(a){if(this.opener){_.invoke(this.cardViews,"stopListening");this.cardViews=[];this.hammertime.off("release dragleft dragright swipeleft swiperight");this.fastclick.destroy();this.remove();$(window).off("resize.explainer");$(window).off("popstate.explainer");$("body").addClass("explainer-closing");setTimeout(function(){$("body").removeClass("explainer-closing explainer-open")},500);this.opener.closeFullscreen(a)}else{window.location.href=this.exitUrl()}},gotoIndex:function(n,d,l,o){var i=(n<this.currentIndex)?"left":"right";var m=this.$(this.cardSlc).eq(this.currentIndex);var f;var j;var e=n===this.currentIndex;var a=false;if(this.isAnimating){return}if(!o&&!e){if(i==="left"){if(this.checkForAdContent(n+1)){a=true;n+=1}}else{a=this.checkForAdContent(n)}}m.css("overflow-y","");if(l||!this.animationSupport){f=this.$(this.cardSlc).eq(n);j=this.cardModels.get(f.data("id"));this.delayedOnEndAnimation(f,m);this.cardsSeen+=1}else{if(e){this.doBounceAnimation(n,m)}else{f=this.$(this.cardSlc).eq(n);if(f.lenth===0){return}j=this.cardModels.get(f.data("id"));this.doCardAnimation(f,m,i);this.cardsSeen+=1}}this.currentIndex=n;if(a){this.clearTocCurrentItem()}else{if(j){this.updateTocCurrentItem();if(this.historySupport){var c={explainerId:this.model.id,index:n};var h=j.get("title")+" - "+this.model.get("title")+" - Vox";var b=j.get("url");if(window.location.hash!==""){b+=window.location.hash}else{if(this.opener){b+="#E"+Chorus.Context.entry_id}}if(d){window.history.pushState(c,h,b)}else{window.history.replaceState(c,h,b)}document.title=h;if(this.cardsSeen>1){var g=window.location.pathname;if(window.location.hash!==""){g+=window.location.hash}g="/virtual"+g;this.sendAnalytics("pageview",[g])}this.trackCardLinks(m,f)}}}},sendAnalytics:function(a,d){if(!this.isPreview){try{var c=["send",a].concat(d);ga.apply(this,c)}catch(b){}}},trackCardStackSocial:function(){if(Util&&Util.uaTrackEvent){$(".m-explainer__top-nav a.facebook").on("click",{params:["Social","Share Card Stack In Nav","Share Card Stack In Nav Facebook"]},Util.uaTrackEvent);$(".m-explainer__top-nav a.twitter").on("click",{params:["Social","Share Card Stack In Nav","Share Card Stack In Nav Twitter"]},Util.uaTrackEvent);$(".m-explainer__top-nav a.google_plus").on("click",{params:["Social","Share Card Stack In Nav","Share Card Stack In Nav Goo Plus"]},Util.uaTrackEvent);$(".m-explainer__top-nav a.print").on("click",{params:["Social","Share Card Stack In Nav","Share Card Stack In Nav Print"]},Util.uaTrackEvent)}},trackCardLinks:function(b,a){if(Util&&Util.uaTrackEvent){b.find('.m-explainer__card-social a, .m-explainer__card-content p a[href*="/cards/"]').off("click");a.find(".m-explainer__card-social a.facebook").on("click",{params:["Social","Share This Card On Card","Share This Card On Card Facebook"]},Util.uaTrackEvent);a.find(".m-explainer__card-social a.twitter").on("click",{params:["Social","Share This Card On Card","Share This Card On Card Twitter"]},Util.uaTrackEvent);a.find(".m-explainer__card-social a.google_plus").on("click",{params:["Social","Share This Card On Card","Share This Card On Card Goo Plus"]},Util.uaTrackEvent);a.find(".m-explainer__card-social a.print").on("click",{params:["Social","Share This Card On Card","Share This Card On Card Print"]},Util.uaTrackEvent);a.find('.m-explainer__card-content p a[href*="/cards/"]').on("click",{params:["Internal Card Stack Traffic","Card Stack Traffic From Card Stacks","Card Stack Highlighted Text"]},Util.uaTrackEvent)}},doCardAnimation:function(d,h,g){var b=this.animationEndEvent;var f=this.onEndAnimation;var i;var c;var a;var e;d.removeAttr("style").addClass("current");if(g==="right"){a="to-left";e="from-right"}else{a="to-right";e="from-left"}this.isAnimating=true;h.addClass(a).on(b,function(){h.removeClass("current");h.off(b);i=true;if(c){f(d,h)}});d.addClass(e).on(b,function(){d.off(b);c=true;if(i){f(d,h)}})},doBounceAnimation:function(a,d){var c=this.animationEndEvent;var b=this.onEndAnimation;d.removeAttr("style").addClass("current");if(a!==0){bounceClass="bounce-left"}else{bounceClass="bounce-right"}this.isAnimating=true;d.addClass(bounceClass).on(c,function(){d.off(c);b(d)})},onEndAnimation:function(a,b){var c=this.cardModels.get(a.data("id"));if(c){Vox.Explainers.VideoUtil.loadVideos(a,c.get("chorus_videos"))}a.removeClass("to-left to-right from-left from-right bounce-right bounce-left");a.addClass("current");setTimeout(function(){a.css("overflow-y","auto")},1);if(b){if(b.hasClass(this.adClass)){this.removeCard(b)}else{if(!b.is(a)){b.removeClass("current")}b.removeAttr("style").removeClass("to-left to-right from-left from-right bounce-right bounce-left");b.scrollTop(0)}}this.isAnimating=false},delayedOnEndAnimation:function(a,b){var c=this;setTimeout(function(){c.onEndAnimation(a,b)},1)},gotoNext:function(){var a=(this.currentIndex===this.cardCount()-1)?this.currentIndex:this.currentIndex+1;this.gotoIndex(a,true)},gotoPrev:function(){var a=(this.currentIndex===0)?this.currentIndex:this.currentIndex-1;this.gotoIndex(a,true)},onTocClick:function(b){var a=$(b.currentTarget).data("index");if(this.railOpen){this.toggleMobileRail(b)}this.gotoIndex(a,true,false,true);this.sendAnalytics("event",["Explainer Fullscreen","TOC Click",a]);b.preventDefault()},prefetchCards:function(){if(!this.isPreview&&!this.model.loaded&&!this.model.loading){this.model.loading=true;this.model.fetch({success:function(a){a.loaded=true;a.loading=false},error:function(a){a.loaded=false;a.loading=false}})}},onPopstate:function(b){var a=b.originalEvent.state;if(a&&a.explainerId===this.model.id){this.gotoIndex(a.index,false)}else{if(this.opener){this.close(false)}else{if(window.location.href.indexOf(this.model.get("url"))>=0){}else{if(this.isPreview){}else{window.location.reload()}}}}},keyboardNavigation:function(d){var c=this.$(this.cardSlc).eq(this.currentIndex);var a=d.keyCode||d.which,b={left:37,right:39,up:38,down:40,j:74,k:75,escape:27,pageUp:33,pageDown:34,home:36};switch(a){case b.k:case b.left:this.gotoPrev();d.preventDefault();this.sendAnalytics("event",["Explainer Fullscreen","Prev Key"]);break;case b.j:case b.right:this.gotoNext();d.preventDefault();this.sendAnalytics("event",["Explainer Fullscreen","Next Key"]);break;case b.down:c.scrollTop(c.scrollTop()+25);d.preventDefault();break;case b.up:c.scrollTop(c.scrollTop()-25);d.preventDefault();break;case b.pageUp:c.scrollTop(c.scrollTop()-400);d.preventDefault();break;case b.pageDown:c.scrollTop(c.scrollTop()+400);d.preventDefault();break;case b.home:c.scrollTop(0);d.preventDefault();break;case b.escape:this.close(true);d.preventDefault();this.sendAnalytics("event",["Explainer Fullscreen","Close Key"]);break}},checkForAdContent:function(a){var c=false;var b=_.bind(function(f,d){this.addCard(d,a,{isAd:true});c=true},this);$(document).on(this.adResponseEvent,b);$(document).triggerHandler(this.adRequestEvent,{pagesSeen:this.cardsSeen,currentPage:this.currentIndex,nextPage:a,totalPages:this.cardCount()});$(document).off(this.adResponseEvent,b);return c}});var Chorus=Chorus||{};Chorus.UserMessaging=(function(f){var d;var l=Chorus.Context.network_slug==="polygon";var j=30000;var c=4000;function b(m){m.on("webkittransitionend transitionend otransitionEnd mstransitionend transitionend",function(){m.remove()});m.addClass("is-closed")}function i(m){m.preventDefault();m.stopPropagation();b(f(m.delegateTarget))}function g(){var m=f(".m-user-msg__notice");if(m.length>1){h()}m.first().find(".m-user-msg__close").trigger("click")}function h(){if(l===true){dur=(f(".m-user-msg__notice_short").length>0)?c:j;to=setTimeout(g,dur)}}function e(){f(".m-user-msg__notice, .m-user-msg__error").on("click",".m-user-msg__close",i)}function a(){f(".m-user-msg__modal").each(function(){Chorus.EventDispatcher.publish("modal_open",{content:f(this)})})}return{init:function(){if(f(".m-user-msg").length<1){return}a();e();h()}}})(jQuery);jQuery(Chorus.UserMessaging.init);var Chorus=Chorus||{};Chorus.Modal=(function(e){var t=null;var n,q,u;var f=[];var w=false;function p(){if(t!==null){return}var y=e(u());n.append(y);y.on("click",o);t=y.find(".m-chorus-modal__root").addBack(".m-chorus-modal__root").first()}function d(){p();n.addClass("chorus-modal-loading")}function x(){n.removeClass("chorus-modal-loading")}function b(){p();n.addClass("chorus-modal-open")}function c(){n.removeClass("chorus-modal-open")}function r(y){d();var z=y.data||{};y.success=function(A){y.content=A;l(y)};y.error=function(B,A){if(A!=="abort"){alert("There was an error recieving data from the server.")}x()};f.push(e.ajax(y))}function l(z){x();b();var y=e(q(z));y.find(".m-chorus-modal__window-root").append(z.content);y.data("chorus-modal-callbacks",z.callbacks);t.prepend(y);y.on("click","*[data-chorus-modal-action]",s);i("attach",y)}function v(y){y.remove();if(t.children().length===0){c();x()}}function g(y){y.callbacks=y.callbacks||{};y.title=y.title||"Untitled Modal";y.content=y.content||null;if(y.url){r(y)}else{if(y.content!==null){l(y)}}}function i(A,z){var y=z.data("chorus-modal-callbacks");if(A==="cancel_confirm"){if(confirm("Are you sure you want to close this window?")){A="cancel"}else{return}}if(A=="cancel"){v(z)}if(typeof(y[A])==="function"){y[A](z)}}function a(){e(".m-chorus-modal__window").each(function(){i("cancel",e(this))});if(t!==null){t.empty()}c();x();while(f.length>0){f.pop().abort()}}function j(){w=true;var y=e("#chorus-modal-window-template").html()||"";var z=e("#chorus-modal-wrapper-template").html()||"";n=e("body");q=_.template(y);u=_.template(z)}function s(y){y.preventDefault();i(e(y.target).data("chorus-modal-action").toString().trim(),e(y.delegateTarget))}function o(y){if(e(y.target).is(t)){a()}}function h(y){if(w===false){j()}g(y)}function m(y){a()}return{init:function(){Chorus.EventDispatcher.subscribe("modal_open",h);Chorus.EventDispatcher.subscribe("modal_close",m)},open:function(y){Chorus.EventDispatcher.publish("modal_open",y)},close:function(y){Chorus.EventDispatcher.publish("modal_close",y)}}})(jQuery);Chorus.Modal.init();shortcut={all_shortcuts:{},add:function(b,h,d){var g={type:"keydown",propagate:false,disable_in_input:false,target:document,keycode:false};if(!d){d=g}else{for(var a in g){if(typeof d[a]=="undefined"){d[a]=g[a]}}}var f=d.target;if(typeof d.target=="string"){f=document.getElementById(d.target)}var c=this;b=b.toLowerCase();var e=function(o){o=o||window.event;if(d.disable_in_input){var l;if(o.target){l=o.target}else{if(o.srcElement){l=o.srcElement}}if(l.nodeType==3){l=l.parentNode}if(l.tagName=="INPUT"||l.tagName=="TEXTAREA"){return}}if(o.keyCode){code=o.keyCode}else{if(o.which){code=o.which}}var n=String.fromCharCode(code).toLowerCase();if(code==188){n=","}if(code==190){n="."}var s=b.split("+");var r=0;var p={"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"};var m={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123};var q={shift:{wanted:false,pressed:false},ctrl:{wanted:false,pressed:false},alt:{wanted:false,pressed:false},meta:{wanted:false,pressed:false}};if(o.ctrlKey){q.ctrl.pressed=true}if(o.shiftKey){q.shift.pressed=true}if(o.altKey){q.alt.pressed=true}if(o.metaKey){q.meta.pressed=true}for(var j=0;k=s[j],j<s.length;j++){if(k=="ctrl"||k=="control"){r++;q.ctrl.wanted=true}else{if(k=="shift"){r++;q.shift.wanted=true}else{if(k=="alt"){r++;q.alt.wanted=true}else{if(k=="meta"){r++;q.meta.wanted=true}else{if(k.length>1){if(m[k]==code){r++}}else{if(d.keycode){if(d.keycode==code){r++}}else{if(n==k){r++}else{if(p[n]&&o.shiftKey){n=p[n];if(n==k){r++}}}}}}}}}}if(r==s.length&&q.ctrl.pressed==q.ctrl.wanted&&q.shift.pressed==q.shift.wanted&&q.alt.pressed==q.alt.wanted&&q.meta.pressed==q.meta.wanted){h(o);if(!d.propagate){o.cancelBubble=true;o.returnValue=false;if(o.stopPropagation){o.stopPropagation();o.preventDefault()}return false}}};this.all_shortcuts[b]={callback:e,target:f,event:d.type};if(f.addEventListener){f.addEventListener(d.type,e,false)}else{if(f.attachEvent){f.attachEvent("on"+d.type,e)}else{f["on"+d.type]=e}}},remove:function(a){a=a.toLowerCase();var d=this.all_shortcuts[a];delete (this.all_shortcuts[a]);if(!d){return}var b=d.event;var c=d.target;var e=d.callback;if(c.detachEvent){c.detachEvent("on"+b,e)}else{if(c.removeEventListener){c.removeEventListener(b,e,false)}else{c["on"+b]=false}}}};(function($){$.fn.markItUp=function(settings,extraSettings){var method,params,options,ctrlKey,shiftKey,altKey;ctrlKey=shiftKey=altKey=false;if(typeof settings=="string"){method=settings;params=extraSettings}options={id:"",nameSpace:"",root:"",previewHandler:false,previewInWindow:"",previewInElement:"",previewAutoRefresh:true,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParser:false,previewParserPath:"",previewParserVar:"data",resizeHandle:true,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};$.extend(options,settings,extraSettings);if(!options.root){$("script").each(function(a,tag){miuScript=$(tag).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);if(miuScript!==null){options.root=miuScript[1]}})}var uaMatch=function(ua){ua=ua.toLowerCase();var match=/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[];return{browser:match[1]||"",version:match[2]||"0"}};var matched=uaMatch(navigator.userAgent);var browser={};if(matched.browser){browser[matched.browser]=true;browser.version=matched.version}if(browser.chrome){browser.webkit=true}else{if(browser.webkit){browser.safari=true}}return this.each(function(){var $$,textarea,levels,scrollPosition,caretPosition,caretOffset,clicked,hash,header,footer,previewWindow,template,iFrame,abort;$$=$(this);textarea=this;levels=[];abort=false;scrollPosition=caretPosition=0;caretOffset=-1;options.previewParserPath=localize(options.previewParserPath);options.previewTemplatePath=localize(options.previewTemplatePath);if(method){switch(method){case"remove":remove();break;case"insert":markup(params);break;default:$.error("Method "+method+" does not exist on jQuery.markItUp")}return}function localize(data,inText){if(inText){return data.replace(/("|')~\//g,"$1"+options.root)}return data.replace(/^~\//,options.root)}function init(){id="";nameSpace="";if(options.id){id='id="'+options.id+'"'}else{if($$.attr("id")){id='id="markItUp'+($$.attr("id").substr(0,1).toUpperCase())+($$.attr("id").substr(1))+'"'}}if(options.nameSpace){nameSpace='class="'+options.nameSpace+'"'}$$.wrap("<div "+nameSpace+"></div>");$$.wrap("<div "+id+' class="markItUp"></div>');$$.wrap('<div class="markItUpContainer"></div>');$$.addClass("markItUpEditor");header=$('<div class="markItUpHeader"></div>').insertBefore($$);$(dropMenus(options.markupSet)).appendTo(header);footer=$('<div class="markItUpFooter"></div>').insertAfter($$);if(options.resizeHandle===true&&browser.safari!==true){resizeHandle=$('<div class="markItUpResizeHandle"></div>').insertAfter($$).bind("mousedown.markItUp",function(e){var h=$$.height(),y=e.clientY,mouseMove,mouseUp;mouseMove=function(e){$$.css("height",Math.max(20,e.clientY+h-y)+"px");return false};mouseUp=function(e){$("html").unbind("mousemove.markItUp",mouseMove).unbind("mouseup.markItUp",mouseUp);return false};$("html").bind("mousemove.markItUp",mouseMove).bind("mouseup.markItUp",mouseUp)});footer.append(resizeHandle)}$$.bind("keydown.markItUp",keyPressed).bind("keyup",keyPressed);$$.bind("insertion.markItUp",function(e,settings){if(settings.target!==false){get()}if(textarea===$.markItUp.focused){markup(settings)}});$$.bind("focus.markItUp",function(){$.markItUp.focused=this});if(options.previewInElement){refreshPreview()}}function dropMenus(markupSet){var ul=$("<ul></ul>"),i=0;$("li:hover > ul",ul).css("display","block");$.each(markupSet,function(){var button=this,t="",title,li,j;title=(button.key)?(button.name||"")+" [Ctrl+"+button.key+"]":(button.name||"");key=(button.key)?'accesskey="'+button.key+'"':"";if(button.separator){li=$('<li class="markItUpSeparator">'+(button.separator||"")+"</li>").appendTo(ul)}else{i++;for(j=levels.length-1;j>=0;j--){t+=levels[j]+"-"}li=$('<li class="markItUpButton markItUpButton'+t+(i)+" "+(button.className||"")+'"><a href="" '+key+' title="'+title+'">'+(button.name||"")+"</a></li>").bind("contextmenu.markItUp",function(){return false}).bind("click.markItUp",function(e){e.preventDefault()}).bind("focusin.markItUp",function(){$$.focus()}).bind("mouseup",function(){if(button.call){eval(button.call)()}markup(button);return false}).bind("mouseenter.markItUp",function(){$("> ul",this).show();$(document).one("click",function(){$("ul ul",header).hide()})}).bind("mouseleave.markItUp",function(){$("> ul",this).hide()}).appendTo(ul);if(button.dropMenu){levels.push(i);$(li).addClass("markItUpDropMenu").append(dropMenus(button.dropMenu))}}});levels.pop();return ul}function magicMarkups(string){if(string){string=string.toString();string=string.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(x,a){var b=a.split("|!|");if(altKey===true){return(b[1]!==undefined)?b[1]:b[0]}else{return(b[1]===undefined)?"":b[0]}});string=string.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(x,a){var b=a.split(":!:");if(abort===true){return false}value=prompt(b[0],(b[1])?b[1]:"");if(value===null){abort=true}return value});return string}return""}function prepare(action){if($.isFunction(action)){action=action(hash)}return magicMarkups(action)}function build(string){var openWith=prepare(clicked.openWith);var placeHolder=prepare(clicked.placeHolder);var replaceWith=prepare(clicked.replaceWith);var closeWith=prepare(clicked.closeWith);var openBlockWith=prepare(clicked.openBlockWith);var closeBlockWith=prepare(clicked.closeBlockWith);var multiline=clicked.multiline;if(replaceWith!==""){block=openWith+replaceWith+closeWith}else{if(selection===""&&placeHolder!==""){block=openWith+placeHolder+closeWith}else{string=string||selection;var lines=[string],blocks=[];if(multiline===true){lines=string.split(/\r?\n/)}for(var l=0;l<lines.length;l++){line=lines[l];var trailingSpaces;if(trailingSpaces=line.match(/ *$/)){blocks.push(openWith+line.replace(/ *$/g,"")+closeWith+trailingSpaces)}else{blocks.push(openWith+line+closeWith)}}block=blocks.join("\n")}}block=openBlockWith+block+closeBlockWith;return{block:block,openBlockWith:openBlockWith,openWith:openWith,replaceWith:replaceWith,placeHolder:placeHolder,closeWith:closeWith,closeBlockWith:closeBlockWith}}function markup(button){var len,j,n,i;hash=clicked=button;get();$.extend(hash,{line:"",root:options.root,textarea:textarea,selection:(selection||""),caretPosition:caretPosition,ctrlKey:ctrlKey,shiftKey:shiftKey,altKey:altKey});prepare(options.beforeInsert);prepare(clicked.beforeInsert);if((ctrlKey===true&&shiftKey===true)||button.multiline===true){prepare(clicked.beforeMultiInsert)}$.extend(hash,{line:1});if((ctrlKey===true&&shiftKey===true)){lines=selection.split(/\r?\n/);for(j=0,n=lines.length,i=0;i<n;i++){if($.trim(lines[i])!==""){$.extend(hash,{line:++j,selection:lines[i]});lines[i]=build(lines[i]).block}else{lines[i]=""}}string={block:lines.join("\n")};start=caretPosition;len=string.block.length+((browser.opera)?n-1:0)}else{if(ctrlKey===true){string=build(selection);start=caretPosition+string.openWith.length;len=string.block.length-string.openWith.length-string.closeWith.length;len=len-(string.block.match(/ $/)?1:0);len-=fixIeBug(string.block)}else{if(shiftKey===true){string=build(selection);start=caretPosition;len=string.block.length;len-=fixIeBug(string.block)}else{string=build(selection);start=caretPosition+string.block.length;len=0;start-=fixIeBug(string.block)}}}if((selection===""&&string.replaceWith==="")){caretOffset+=fixOperaBug(string.block);start=caretPosition+string.openBlockWith.length+string.openWith.length;len=string.block.length-string.openBlockWith.length-string.openWith.length-string.closeWith.length-string.closeBlockWith.length;caretOffset=$$.val().substring(caretPosition,$$.val().length).length;caretOffset-=fixOperaBug($$.val().substring(0,caretPosition))}$.extend(hash,{caretPosition:caretPosition,scrollPosition:scrollPosition});if(string.block!==selection&&abort===false){insert(string.block);set(start,len)}else{caretOffset=-1}get();$.extend(hash,{line:"",selection:selection});if((ctrlKey===true&&shiftKey===true)||button.multiline===true){prepare(clicked.afterMultiInsert)}prepare(clicked.afterInsert);prepare(options.afterInsert);if(previewWindow&&options.previewAutoRefresh){refreshPreview()}shiftKey=altKey=ctrlKey=abort=false}function fixOperaBug(string){if(browser.opera){return string.length-string.replace(/\n*/g,"").length}return 0}function fixIeBug(string){if(browser.msie){return string.length-string.replace(/\r*/g,"").length}return 0}function insert(block){if(document.selection){var newSelection=document.selection.createRange();newSelection.text=block}else{textarea.value=textarea.value.substring(0,caretPosition)+block+textarea.value.substring(caretPosition+selection.length,textarea.value.length)}}function set(start,len){if(textarea.createTextRange){if(browser.opera&&browser.version>=9.5&&len==0){return false}range=textarea.createTextRange();range.collapse(true);range.moveStart("character",start);range.moveEnd("character",len);range.select()}else{if(textarea.setSelectionRange){textarea.setSelectionRange(start,start+len)}}textarea.scrollTop=scrollPosition;textarea.focus()}function get(){textarea.focus();scrollPosition=textarea.scrollTop;if(document.selection){selection=document.selection.createRange().text;if(browser.msie){var range=document.selection.createRange(),rangeCopy=range.duplicate();rangeCopy.moveToElementText(textarea);caretPosition=-1;while(rangeCopy.inRange(range)){rangeCopy.moveStart("character");caretPosition++}}else{caretPosition=textarea.selectionStart}}else{caretPosition=textarea.selectionStart;selection=textarea.value.substring(caretPosition,textarea.selectionEnd)}return selection}function preview(){if(typeof options.previewHandler==="function"){previewWindow=true}else{if(options.previewInElement){previewWindow=$(options.previewInElement)}else{if(!previewWindow||previewWindow.closed){if(options.previewInWindow){previewWindow=window.open("","preview",options.previewInWindow);$(window).unload(function(){previewWindow.close()})}else{iFrame=$('<iframe class="markItUpPreviewFrame"></iframe>');if(options.previewPosition=="after"){iFrame.insertAfter(footer)}else{iFrame.insertBefore(header)}previewWindow=iFrame[iFrame.length-1].contentWindow||frame[iFrame.length-1]}}else{if(altKey===true){if(iFrame){iFrame.remove()}else{previewWindow.close()}previewWindow=iFrame=false}}}}if(!options.previewAutoRefresh){refreshPreview()}if(options.previewInWindow){previewWindow.focus()}}function refreshPreview(){renderPreview()}function renderPreview(){var phtml;if(options.previewHandler&&typeof options.previewHandler==="function"){options.previewHandler($$.val())}else{if(options.previewParser&&typeof options.previewParser==="function"){var data=options.previewParser($$.val());writeInPreview(localize(data,1))}else{if(options.previewParserPath!==""){$.ajax({type:"POST",dataType:"text",global:false,url:options.previewParserPath,data:options.previewParserVar+"="+encodeURIComponent($$.val()),success:function(data){writeInPreview(localize(data,1))}})}else{if(!template){$.ajax({url:options.previewTemplatePath,dataType:"text",global:false,success:function(data){writeInPreview(localize(data,1).replace(/<!-- content -->/g,$$.val()))}})}}}}return false}function writeInPreview(data){if(options.previewInElement){$(options.previewInElement).html(data)}else{if(previewWindow&&previewWindow.document){try{sp=previewWindow.document.documentElement.scrollTop}catch(e){sp=0}previewWindow.document.open();previewWindow.document.write(data);previewWindow.document.close();previewWindow.document.documentElement.scrollTop=sp}}}function keyPressed(e){shiftKey=e.shiftKey;altKey=e.altKey;ctrlKey=(!(e.altKey&&e.ctrlKey))?(e.ctrlKey||e.metaKey):false;if(e.type==="keydown"){if(ctrlKey===true){li=$('a[accesskey="'+((e.keyCode==13)?"\\n":String.fromCharCode(e.keyCode))+'"]',header).parent("li");if(li.length!==0){ctrlKey=false;li.triggerHandler("mouseup");return false}}if(e.keyCode===13||e.keyCode===10){if(ctrlKey===true){ctrlKey=false;markup(options.onCtrlEnter);return options.onCtrlEnter.keepDefault}else{if(shiftKey===true){shiftKey=false;markup(options.onShiftEnter);return options.onShiftEnter.keepDefault}else{markup(options.onEnter);return options.onEnter.keepDefault}}}if(e.keyCode===9){if(shiftKey==true||ctrlKey==true||altKey==true){return false}if(caretOffset!==-1){get();caretOffset=$$.val().length-caretOffset;set(caretOffset,0);caretOffset=-1;return false}else{markup(options.onTab);return options.onTab.keepDefault}}}}function remove(){$$.unbind(".markItUp").removeClass("markItUpEditor");$$.parent("div").parent("div.markItUp").parent("div").replaceWith($$);$$.data("markItUp",null)}init()})};$.fn.markItUpRemove=function(){return this.each(function(){$(this).markItUp("remove")})};$.markItUp=function(settings){var options={target:false};$.extend(options,settings);if(options.target){return $(options.target).each(function(){$(this).focus();$(this).trigger("insertion",[options])})}else{$("textarea").trigger("insertion",[options])}}})(jQuery);window.Chorus||(Chorus={});Chorus.Comments=_.extend({},Backbone.Events,{Collections:{},Models:{},Views:{},Mixins:{},autoUpdateTimeout:null,defaults:{ajaxParams:{},ajaxTimeout:15000,alertErrors:true,autoUpdateAlertMaxShown:5,autoUpdateAlertTimeShown:6500,autoUpdateEnabled:false,buildAncestry:true,currentAutoUpdateInterval:20000,editTimeWindow:90,emptyUpdateTolerance:5,fastAutoUpdateInterval:20000,flaggedThreshold:1,localClockOffset:null,markItUp:{onShiftEnter:{keepDefault:false,replaceWith:"\n\n"},markupSet:[{name:"Bold",key:"B",closeWith:"*",openWith:"*"},{name:"Italic",key:"I",closeWith:"_",openWith:"_"},{name:"Strike through",key:"S",closeWith:"-",openWith:"-"},{name:"Spoilers",key:"F",openWith:"%(spoiler)",closeWith:"%"},{separator:"---------------"},{name:"Bulleted list",openWith:"* ",multiline:true},{name:"Numeric list",openWith:"# ",multiline:true},{separator:"---------------"},{name:"Picture",openWith:"![![Source:!:http://]!](",closeWith:")!"},{name:"Link",openWith:'"',closeWith:'(!(([![Title (Shown on hover)]!]))!)":[![Link:!:http://]!]',placeHolder:"Your text to link here..."},{separator:"---------------"},{name:"Quotes",openWith:"bq. "}],resizeHandle:false},maxIndentationDepth:30,offsetHeight:Math.floor(jQuery(window).height()*0.333),recommendedThreshold:1,renderChunkLength:200,renderTo:"#comments",scrollAnimationDuration:300,scrollBuffer:0,showAutoUpdateAlert:true,showAvatars:true,showSignatures:true,showImages:true,slowAutoUpdateInterval:60000,sortMethod:"ancestry",startOnScroll:(Chorus.Environment.currentBreakpoint().index>1)},settings:{},initialize:function(b,a){this.stop();this.started=false;this.context={};this.settings=_.extend({},this.defaults,this.settings,a);this.collection=new Chorus.Comments.Collections.Comments([],{entryId:b});if(this.settings.renderTo){this.compileTemplates();this.view=new Chorus.Comments.Views.Main({el:this.settings.renderTo,collection:this.collection});this.view.render()}if(window.location.hash.match(/^#\d+$/)){this.start()}return this},initContext:function(a){this.context=a;this.settings.autoUpdateEnabled=this.settings.autoUpdateEnabled&&this.context.able_to_comment&&!this.context.comments_closed&&Chorus.Environment.currentBreakpoint().index>1;if(this.settings.autoUpdateEnabled){this.startAutoUpdate()}},start:function(){if(this.started){return}this.started=true;this.listenTo(this,"ajaxSuccess",this.ajaxSuccess);this.listenTo(this,"ajaxError",this.ajaxError);this.collection.load();this.trigger("start");return this},stop:function(){if(this.view){this.view.remove()}this.view=null;this.collection=null;this.started=false;this.trigger("stop");this.stopListening();return this},compileTemplates:function(){_.each(Chorus.Comments.Views,function(b){if(b.prototype.templateId){var a=jQuery("#"+b.prototype.templateId).html()||"";b.prototype.template=_.template(a)}})},scheduleAutoUpdate:function(b){if(!this.settings.autoUpdateEnabled){return}var a;if(b.emptyUpdateCount<this.settings.emptyUpdateTolerance){a=this.settings.fastAutoUpdateInterval}else{a=this.settings.slowAutoUpdateInterval}this.settings.currentAutoUpdateInterval=a;clearTimeout(this.autoUpdateTimeout);this.autoUpdateTimeout=setTimeout(function(){b.update()},a)},startAutoUpdate:function(){this.settings.autoUpdateEnabled=true;this.listenTo(this.collection,"updateSuccess updateError",this.scheduleAutoUpdate);this.scheduleAutoUpdate(this.collection)},stopAutoUpdate:function(){this.settings.autoUpdateEnabled=false;this.stopListening(this.collection,"updateSuccess updateError",this.scheduleAutoUpdate);clearTimeout(this.autoUpdateTimeout);this.autoUpdateTimeout=null},openModal:function(a){Chorus.EventDispatcher.publish("modal_open",{content:a})},closeModal:function(){Chorus.EventDispatcher.publish("modal_close")},ajaxSuccess:function(b,a,g,c){var d=Date.parse(g.getResponseHeader("Date"));var f=(new Date().valueOf()-d.valueOf())/1000;var e=this.settings.localClockOffset;if(_.isNumber(e)){this.settings.localClockOffset=(e+f)/2}else{this.settings.localClockOffset=f}},ajaxError:function(f,a,e,d){try{var b=JSON.parse(f.responseText);if(b.message&&this.settings.alertErrors){alert(b.message)}}catch(c){}}});Chorus.Comments.Mixins.Ajax={urlFor:function(b){var a=this.urls[b];if(a){a=a.replace(/:([^\/]+)/,_.bind(function(d,c){return(this instanceof Backbone.Model)?this.get(c):this[c]},this))}return a},ajax:function(e,b){var a=this.urlFor(e);if(!a){throw"ArgumentError: No url specified for action: "+e}var d=this;var c=_.extend({url:a,dataType:"json",context:this,timeout:Chorus.Comments.settings.ajaxTimeout},this.ajaxOptions||{},b);if(c.data&&_.isObject(c.data)&&c.type==="POST"){c.contentType="application/json";c.data=JSON.stringify(c.data);c.processData=false}c.error=function(h,f,g){if(b&&_.isFunction(b.error)){b.error.call(c.context,d,g)}d.trigger(e+"Error",d,g,h);Chorus.Comments.trigger("ajaxError",h,f,g,d)};c.success=function(g,f,h){if(b&&_.isFunction(b.success)){b.success.call(c.context,d,g)}d.trigger(e+"Success",d,g,h);Chorus.Comments.trigger("ajaxSuccess",g,f,h,d)};d.trigger(e+"Start",d);Chorus.Comments.trigger("ajaxStart",d);return jQuery.ajax(c)}};Chorus.Comments.Models.Comment=Backbone.Model.extend(_.extend({},Chorus.Comments.Mixins.Ajax,{ajaxOptions:{type:"POST"},urls:{preview:"/comments/preview_comment",post:"/comments/post_comment",edit:"/comments/edit_comment/:id",hide:"/comments/hide_comment/:id",flag:"/comments/flag_comment/:id",unflag:"/comments/unflag_comment/:id",recommend:"/comments/recommend_comment/:id",destroy:"/comments/destroy_comment/:id",loadFlaggings:"/comments/ajax_comment_flags/:id",blockUser:"/comments/block_user/:id"},initialize:function(){if(Chorus.Comments.settings.buildAncestry&&(!this.get("ancestry")||!this.get("depth"))){this.buildAncestry()}this.listenTo(this,"change:id change:parent_id",this.buildAncestry);this.listenTo(this,"change:collapsed",this.collapseDescendants)},buildAncestry:function(){var c=function(e){e=e.toString();return e.length>=10?e:new Array(10-e.length+1).join("0")+e};var a=this.id?c(this.id):"preview";var b=this.parent();var d;if(b){a=b.get("ancestry")+"/"+a}d=a.split("/").length;d=Math.min(d,Chorus.Comments.settings.maxIndentationDepth);this.set({ancestry:a,depth:d},{silent:true})},user:function(){return this.collection.users.get(this.get("user_id"))||new Chorus.Comments.Models.User({display_name:"anonymous"})},parent:function(){var a=this.get("parent_id");if(a){return this.collection.get(a)}else{return null}},ancestors:function(){if(!this.get("ancestry")){return[]}var a=this.get("ancestry").split("/");a.pop();return _.map(a,function(b){b=parseInt(b,10);return this.collection.get(b)},this)},descendants:function(){var a=new RegExp("^"+this.get("ancestry")+"/");return this.collection.filter(function(b){return a.test(b.get("ancestry"))})},matchesConditions:function(b){for(var a in b){if(b[a]!=this.get(a)){return false}}return true},findNeighbor:function(f,e,b){var g=this.collection.indexOf(this);var a=this.collection.length-1;var c=g;var d;if(a===0){return null}do{c=(b)?c-1:c+1;if(!e&&(c<0||c>a)){return null}else{if(c<0){c=a}else{if(c>a){c=0}}}d=this.collection.at(c);if(d&&d.matchesConditions(f)){return d}}while(c!==g);return null},prev:function(b,a){return this.findNeighbor(b,a,true)},next:function(b,a){return this.findNeighbor(b,a,false)},flaggings:function(){return this.collection.flaggings.where({flaggable_id:this.id})},isFlagged:function(){return this.get("bad_flags_count")>=Chorus.Comments.settings.flaggedThreshold},isRecommended:function(){return this.get("recommended_flags_count")>=Chorus.Comments.settings.recommendedThreshold},createFlagging:function(a){return this.collection.flaggings.add({flag_name:a,flaggable_id:this.id,user_id:Chorus.Comments.context.user_id,created_on:new Date()})},secondsSinceCreate:function(){var b=Chorus.Comments.settings.localClockOffset||0;var a=new Date().getTime()/1000;a=Math.round(a-b);return a-this.get("created_on_timestamp")},isEditable:function(){return this.get("user_id")===Chorus.Comments.context.user_id&&this.secondsSinceCreate()<Chorus.Comments.settings.editTimeWindow},isPreview:function(){return !this.id},toJSON:function(){var b=_.clone(this.attributes);var a;b.is_flagged=this.isFlagged();b.is_recommended=this.isRecommended();b.is_editable=this.isEditable();b.is_preview=this.isPreview();b.permalink=this.getAbsoluteURL("permalink");b.shortlink=this.getAbsoluteURL("shortlink");if(Chorus.Environment.currentBreakpoint().index<2){b.created_on=this.get("created_on_short")}else{b.created_on=this.get("created_on_long")}a=this.user();if(a){b.user=a.toJSON(true)}return b},getAbsoluteURL:function(a){return window.location.origin+this.get(a)},preview:function(){return this.ajax("preview",{data:{entry_id:this.collection.entryId,comment:_.pick(this.attributes,"user_id","parent_id","title","body")},success:function(b,a){b.collection.users.add(a,{parse:true});b.set(a.comments[0])}})},post:function(){var a=this.get("body");if(a){this.set("rawBody",a)}return this.ajax("post",{data:{entry_id:this.collection.entryId,comment:_.pick(this.attributes,"user_id","parent_id","title","body")},success:function(c,b){c.collection.users.add(b,{parse:true});c.set(b.comments[0]);c.collection.add(c)}})},edit:function(a){if(a.body){this.set("rawBody",a.body)}return this.ajax("edit",{data:{entry_id:this.collection.entryId,comment:a},success:function(c,b){c.set(b.comments[0])}})},hide:function(){var a={};var b=this.descendants();_.each(b,function(c){a[c.id]=c.get("hidden");c.set("hidden",true)});this.set("hidden",true);return this.ajax("hide",{error:function(c){c.set("hidden",false);_.each(b,function(d){d.set("hidden",a[d.id])})}})},unhide:function(){this.set("hidden",false);return this.ajax("hide",{error:function(a){a.set("hidden",true)}})},flag:function(b){var a=this.createFlagging("inappropriate");this.set({is_flagged_by_user:true,bad_flags_count:this.get("bad_flags_count")+1});return this.ajax("flag",{data:b,error:function(c){c.set({is_flagged_by_user:false,bad_flags_count:c.get("bad_flags_count")-1});c.collection.flaggings.remove(a)}})},unflag:function(){var a=this.flaggingsLoaded;var b=this.flaggings();this.flaggingsLoaded=false;this.collection.flaggings.remove(b);this.set({is_flagged_by_user:false,bad_flags_count:this.get("bad_flags_count")-1});return this.ajax("unflag",{error:function(c){c.set({is_flagged_by_user:true,bad_flags_count:c.get("bad_flags_count")+1});c.collection.flaggings.add(b);c.flaggingsLoaded=a}})},recommend:function(){var a=this.createFlagging("recommended");this.set({is_recommended_by_user:true,recommended_flags_count:(this.get("recommended_flags_count")||0)+1});return this.ajax("recommend",{error:function(b){b.set({is_recommended_by_user:false,recommended_flags_count:b.get("recommended_flags_count")-1});b.collection.flaggings.remove(a)}})},unrecommend:function(){var a=this.flaggings();this.collection.flaggings.remove(a);this.set({is_recommended_by_user:false,recommended_flags_count:this.get("recommended_flags_count")-1});return this.ajax("unflag",{error:function(b){b.set({is_recommended_by_user:true,recommended_flags_count:b.get("recommended_flags_count")+1});b.collection.flaggings.add(a)}})},destroy:function(){var a=this.collection;var b=this.descendants();a.remove(b);a.remove(this);return this.ajax("destroy",{error:function(c){a.add(c);a.add(b)}})},loadFlaggings:function(){return this.ajax("loadFlaggings",{type:"GET",success:function(b,a){b.collection.users.add(a,{parse:true,merge:true});b.collection.flaggings.add(a,{parse:true,merge:true});b.flaggingsLoaded=true}})},collapseDescendants:function(a,b){if(b){_.each(this.descendants(),function(d){if(!d.get("collapsedAncestorId")){d.set("collapsedAncestorId",this.id)}},this)}else{_.each(this.descendants(),function(d){if(d.get("collapsedAncestorId")===this.id){d.set("collapsedAncestorId",null)}},this)}},blockUser:function(){var a=this.user();var c=this.collection;var b=c.where({user_id:this.get("user_id")});c.remove(b);c.users.remove(a);return this.ajax("blockUser",{error:function(){c.users.add(a);c.add(b)}})}}));Chorus.Comments.Models.Flagging=Backbone.Model.extend({initialize:function(){this.set("created_on_timestamp",Math.round(new Date(this.get("created_on")).getTime()/1000))},user:function(){return this.collection.users.get(this.get("user_id"))},flaggable:function(){return this.collection.comments.get(this.get("flaggable_id"))},toJSON:function(){var c=_.clone(this.attributes);var a=this.user();var b=new Date(this.get("created_on")).toLocaleString();c.created_on=b;if(a){c.user=a.toJSON()}return c}});Chorus.Comments.Models.User=Backbone.Model.extend({initialize:function(){var a=this.get("author_profile");var b=this.get("network_membership");if(a){this.set({profile_image:this.get("author_profile").image_url,profile_url:this.get("author_profile").url})}else{if(b){this.set({profile_image:b.image_url,profile_url:b.url})}}},isAuthor:function(){return Chorus.Comments.context.author_id===this.id},isContributor:function(){return _.indexOf(Chorus.Comments.context.contributor_ids,this.id)>-1},toJSON:function(){var a=_.clone(this.attributes);a.is_author=this.isAuthor();a.is_contributor=this.isContributor();return a}});Chorus.Comments.Collections.Comments=Backbone.Collection.extend(_.extend({},Chorus.Comments.Mixins.Ajax,{model:Chorus.Comments.Models.Comment,urls:{load:"/comments/load_comments/:entryId",update:"/comments/ajax_comments_update/:entryId"},loaded:false,lastRequestId:0,emptyUpdateCount:0,initialize:function(b,a){this.entryId=a.entryId;this.users=new Chorus.Comments.Collections.Users();this.flaggings=new Chorus.Comments.Collections.Flaggings([],{users:this.users,comments:this});this.listenTo(this,"add",this.findCollapsedAncestor);return this},comparator:function(e,c){switch(Chorus.Comments.settings.sortMethod){case"ancestry":var f=e.get("ancestry");var d=c.get("ancestry");if(f<d){return -1}else{if(f>d){return 1}else{return 0}}case"forward-chron":if(e.get("created_on_timestamp")===c.get("created_on_timestamp")){return e.get("id")-c.get("id")}else{return e.get("created_on_timestamp")-c.get("created_on_timestamp")}case"reverse-chron":if(e.get("created_on_timestamp")===c.get("created_on_timestamp")){return c.get("id")-e.get("id")}else{return c.get("created_on_timestamp")-e.get("created_on_timestamp")}}},parse:function(a){return a.comments||[]},load:function(){return this.ajax("load",{timeout:null,data:_.extend({t:new Date().getTime()},Chorus.Comments.settings.ajaxParams),success:function(b,a){Chorus.Comments.initContext(a.context);b.loaded=true;b.lastId=a.last_id;b.lastVersion=a.last_version;b.users.reset(a,{parse:true});b.flaggings.reset(a,{parse:true});b.reset(a,{parse:true})}})},update:function(){this.lastRequestId+=1;return this.ajax("update",{data:_.extend({request_id:this.lastRequestId,last_id:this.lastId,last_version:this.lastVersion},Chorus.Comments.settings.ajaxParams),success:function(b,a){if(b.lastRequestId!==a.last_request_id){console.warn("Failed to update comments: updates arrived out of order");return}b.lastId=a.last_id;b.lastVersion=a.last_version;if(a.comments.length){b.emptyUpdateCount=0}else{b.emptyUpdateCount++}_.each(a.deleted_comment_ids,function(d){var c=b.get(d);if(c){b.remove(c.descendants());b.remove(c)}});b.users.add(a,{parse:true});b.add(a,{parse:true});b.flaggings.add(a,{parse:true})},error:function(b,a){b.emptyUpdateCount++}})},findCollapsedAncestor:function(b){var a=_.find(b.ancestors().reverse(),function(d){return d.get("collapsed")});if(a){b.set("collapsedAncestorId",a.id);a.trigger("change")}}}));Chorus.Comments.Collections.Flaggings=Backbone.Collection.extend({model:Chorus.Comments.Models.Flagging,initialize:function(b,a){this.users=a.users;this.comments=a.comments},parse:function(a){return a.flaggings||[]}});Chorus.Comments.Collections.Users=Backbone.Collection.extend({model:Chorus.Comments.Models.User,parse:function(b,a){return b.users||[]},current:function(){return this.get(Chorus.Comments.context.user_id)}});Chorus.Comments.Views.AccountActions=Backbone.View.extend({id:"",className:"",templateId:"comment-account-actions-template",render:function(){this.$el.html(this.template());this.trigger("render",this);return this}});Chorus.Comments.Views.AutoUpdateAlert=Backbone.View.extend({id:"autoupdate_info",templateId:"comment-auto-update-alert-template",events:{"click .close":"hide","click .go_to_comment":"goToComment"},initialize:function(a){this.listenTo(this.collection,"updateSuccess",this.show)},render:function(){this.$el.hide();this.trigger("render",this);return this},show:function(d,a){if(Chorus.Comments.settings.showAutoUpdateAlert===false){return}var c=[];_.each(a.comments,function(h){if(h.user_id!==Chorus.Comments.context.user_id){var e=d.get(h.id);var f=e.toJSON();var g=e.parent();if(g){f.parent=g.toJSON()}c.push(f)}});if(c.length===0){return}var b=this.template({comments:c,settings:Chorus.Comments.settings});this.$el.html(b).fadeIn(1000);setTimeout(_.bind(this.hide,this),Chorus.Comments.settings.autoUpdateAlertTimeShown)},hide:function(){this.$el.fadeOut(500);return false},goToComment:function(a){var b=a.currentTarget.getAttribute("data-comment-id");Chorus.Comments.trigger("activateComment",b);return false}});Chorus.Comments.Views.BaseForm=Backbone.View.extend({events:{"submit form":"submit","click .post_comment_button":"post","click .preview_comment_button":"preview","click .cancel_comment_button":"cancel"},renderPreview:function(a){if(this.previewView){this.previewView.model=a}else{this.previewView=new Chorus.Comments.Views.Comment({model:a})}this.previewView.render().$el.prependTo(this.el);this.$(".preview-controls").show();this.$(".preview_comment_button").prop("disabled",false).val("Preview");return this},formData:function(){var a=this.$("form").serializeArray();var b={};_.each(a,function(c){b[c.name]=c.value});return b},submit:function(){if(this.previewView){this.post()}else{this.preview()}return false},post:function(){var b=this.$(".post_comment_button");b.prop("disabled",true).val(this.submitText+"ing...");var a=new Chorus.Comments.Models.Comment(this.formData(),{collection:this.collection});a.once("postSuccess",function(){this.cancel()},this);a.once("postError",function(){b.prop("disabled",false).val(this.submitText)},this);a.post();return false},preview:function(){var b=this.$(".preview_comment_button");b.prop("disabled",true).val("Previewing...");var a=new Chorus.Comments.Models.Comment(this.formData(),{collection:this.collection});a.once("previewSuccess",this.renderPreview,this);a.once("previewError",function(){b.prop("disabled",false).val("Preview")},this);a.preview();return false},remove:function(){if(this.previewView){this.previewView.remove();this.previewView=null}return Backbone.View.prototype.remove.call(this)}});Chorus.Comments.Views.Comment=Backbone.View.extend({templateId:"comment-template",events:{"click .reply_link":"reply","click .edit_link":"edit","click .flag_link":"toggleFlagged","click .rec_link":"toggleRecommended","click .delete_link":"destroy","click .hide_link":"toggleHidden","click .up_link":"activateParent","click .actions_toggle":"toggleActions","click .inspect_flags_link":"inspectFlags","click .collapse_toggle":"toggleCollapsed","click .image_toggle .message":"toggleImage"},renderTriggers:["id","parent_id","title","body","user_id","signature","hidden","created_on_long","created_on_short","created_on_timestamp","recommended_flags_count","is_recommended_by_user","troll_flags_count","spam_flags_count","inappropriate_flags_count","bad_flags_count","is_flagged_by_user"],initialize:function(){this.listenTo(this.model,"change:"+this.renderTriggers.join(" change:"),this.render);this.listenTo(this.model,"change",this.regenerateWrapperClass);this.listenTo(this.model,"markRead",this.markCollapsedDescendantsRead);this.listenTo(this.model,"remove",this.remove);return this},className:function(){var d=this.model.toJSON();var c=Chorus.Comments.context;var b=[];var a=function(f,e){if(e){b.push(f)}else{b=_.without(b,f)}};if(this.el&&this.el.className){b=b.concat(this.el.className.split(" "))}a("citem",true);a("cdepth-"+d.depth,true);a("recommended",d.is_recommended);a("flagged",c.able_to_moderate&&d.is_flagged);a("new",d.is_new);a("hidden",d.hidden);a("obscured",d.obscured);a("collapsed",d.collapsed);a("collapsed-child",d.collapsedAncestorId);a("moderator",d.is_posted_by_moderator);a("preview",d.is_preview);return _.uniq(b).join(" ")},attributes:function(){return{id:this.model.id}},delegateEvents:function(){},hasProfilePicture:function(){return this.model.user().get("profile_image")&&Chorus.Environment.currentBreakpoint().index>=2&&Chorus.Comments.settings.showAvatars},render:function(){var a=this.model.toJSON();this.$el.html(this.template({view:this,context:Chorus.Comments.context,settings:Chorus.Comments.settings,comment:a}));if(this.model.isEditable()){this.updateEditCountdown()}this.makeImagesHideable();if(this.replyForm){this.$el.append(this.replyForm.el);this.replyForm.delegateEvents()}this.trigger("render",this);return this},makeImagesHideable:function(){var a=this.$(".cbody img");a.wrap('<span href="#" class="image_toggle"></span>').parent().toggleClass("hidden",!Chorus.Comments.settings.showImages).append('<span class="message"></span>');if(Modernizr.localstorage){a.each(function(){var b=jQuery(this);if(localStorage.getItem(b.attr("src"))){b.parent().addClass("hidden")}})}},toggleImage:function(b){jQuery(b.currentTarget).parent().toggleClass("hidden");if(Modernizr.localstorage){var c=jQuery(b.currentTarget).parent();var a=c.find("img").attr("src");c.hasClass("hidden")?localStorage.setItem(a,"hidden"):localStorage.removeItem(a)}return false},renderReplyCounts:function(){var c=this.model.descendants();var b=c.length;if(b>0){var a=_.filter(c,function(e){return e.get("is_new")}).length;var d=(b===1)?"1 reply":b+" replies";if(a>0){d+=", "+a+" new"}this.$(".reply_count").text(d)}},regenerateWrapperClass:function(){this.$el.attr("class",this.className())},updateEditCountdown:function(){var a=Chorus.Comments.settings.editTimeWindow-this.model.secondsSinceCreate();if(a>0){this.$(".countdown_timer").text(Math.round(a));this.$(".countdown_timer_bar").width(100*(a/Chorus.Comments.settings.editTimeWindow)+"%");setTimeout(_.bind(this.updateEditCountdown,this),1000)}else{this.$(".edit_link").remove();this.$(".countdown_timer").text("");this.$(".countdown_timer_bar").remove()}},reply:function(){if(!Chorus.Comments.context.user_id){Chorus.Auth.modal.open("login")}else{if(!Chorus.Comments.context.able_to_comment){var a=jQuery("#comment_tease, #comments .m-user-msg__account-action, #comments .m-user-msg__membership_required").offset();if(a){jQuery("html, body").animate({scrollTop:a.top-Chorus.Comments.settings.offsetHeight},{duration:Chorus.Comments.settings.scrollAnimationDuration})}}else{if(!this.replyForm){this.replyForm=new Chorus.Comments.Views.ReplyForm({model:this.model,collection:this.model.collection});this.replyForm.renderTo(this.el);this.listenTo(this.replyForm,"cancel",function(){this.replyForm=null})}}}return false},edit:function(){this.$el.addClass("ui-state-editing");var a=new Chorus.Comments.Views.EditForm({model:this.model});a.render().$el.prependTo(this.el);a.once("cancel",function(){this.$el.removeClass("ui-state-editing")},this);return false},toggleHidden:function(){var b=this.model.get("hidden");var a=_.any(this.model.ancestors(),function(d){return d.get("hidden")});if(a){alert("You can't "+(b?"unhide":"hide")+" this comment, because its parents are already hidden.")}else{if(b){this.model.unhide()}else{this.model.hide()}}return false},destroy:function(){var a=confirm("You're about to delete this comment and all its replies. Are you sure?");if(a===true){this.model.destroy()}return false},toggleActions:function(){this.$el.toggleClass("ui-state-tools-active");return false},toggleRecommended:function(){if(this.model.get("is_recommended_by_user")){this.model.unrecommend()}else{this.model.recommend()}return false},toggleFlagged:function(){if(this.model.get("is_flagged_by_user")){this.model.unflag()}else{new Chorus.Comments.Views.FlagDialog({model:this.model}).render()}return false},inspectFlags:function(){new Chorus.Comments.Views.InspectFlagsDialog({model:this.model}).render();return false},toggleCollapsed:function(){if(this.model.get("collapsed")){this.uncollapse()}else{this.collapse();this.renderReplyCounts()}return false},collapse:function(){this.model.set("collapsed",true)},uncollapse:function(){this.model.set("collapsed",false)},activate:function(){this.$el.addClass("active");jQuery("html, body").stop(true).animate({scrollTop:this.$el.offset().top-Chorus.Comments.settings.offsetHeight},{duration:Chorus.Comments.settings.scrollAnimationDuration})},activateParent:function(){var a=this.model.parent();if(a){Chorus.Comments.trigger("activateComment",a.id)}return false},deactivate:function(){this.$el.removeClass("active")},markCollapsedDescendantsRead:function(){if(this.model.get("collapsed")){_.each(this.model.descendants(),function(a){a.set("is_new",false)});this.renderReplyCounts()}}});Chorus.Comments.Views.CommentList=Backbone.View.extend({id:"comments_list",className:"comment_master_list",childSelector:".citem",childView:Chorus.Comments.Views.Comment,shortcuts:{"Shift+a":"markAllRead","Shift+c":"activatePrev",c:"activateNext",j:"activateNext",k:"activatePrev",x:"markRead",z:"markReadAndActivateNext",r:"replyToCurrent"},initialize:function(){this.childViews={};this.listenTo(this.collection,"loadSuccess",this.renderAll);this.listenTo(this.collection,"add",this.renderOne);this.listenTo(this.collection,"remove",this.removeOne);this.listenTo(this.collection,"loadSuccess add",this.renderEmbeds);this.listenTo(Chorus.Comments,"activateComment",this.activateId);this.listenTo(this,"renderAll",this.activateHash);_.each(this.shortcuts,function(b,a){shortcut.add(a,_.bind(this[b],this),{disable_in_input:true})},this)},render:function(){return this},delegateEvents:function(){_.each(this.childView.prototype.events,function(d,f){var e=f.match(/^(\S+)\s+(.+)$/);var c=e[1],a=e[2];var g=this.childViews;var b=this.childSelector;this.$el.on(c+".delegateEvents",b+" "+a,function(i){var j=jQuery(this).closest(b);var h=g[j.attr("id")];if(h){return h[d].call(h,i)}})},this);return Backbone.View.prototype.delegateEvents.call(this)},removeAll:function(){this.$el.empty();this.trigger("removeAll",this);this.childViews={};return this},removeOne:function(b){var a=this.childViews[b.id];if(a){a.remove()}delete this.childViews[b.id];this.trigger("removeOne",this,a,b);return this},renderAll:function(){var a=Chorus.Comments.settings;return this.renderPage(0,a.renderChunkLength)},renderPage:function(e,b){var c=Chorus.Comments.settings;var a=_.map(this.collection.slice(e,b),function(f){return this.renderOne(f,false).el},this);this.$el.append(a);this.trigger("renderPage",this,e,b);if(b<this.collection.length){e=b;b=Math.min(this.collection.length,e+Chorus.Comments.settings.renderChunkLength);var d=function(){this.renderPage(e,b)};setTimeout(_.bind(d,this),0)}else{this.trigger("renderAll",this)}return this},renderOne:function(f,e){var c=this.childViews[f.id]||new this.childView({model:f});this.childViews[f.id]=c.render();if(e){var b=this.collection.length;var a=this.collection.indexOf(f)+1;var d;while(!d&&a<b){d=this.collection.at(a++);d=d&&this.childViews[d.id]}if(d){d.$el.before(c.el)}else{this.$el.append(c.el)}this.trigger("renderOne",this,c,f)}return c},renderEmbeds:function(){if(window.twttr&&window.twttr.widgets&&_.isFunction(window.twttr.widgets.load)){window.twttr.widgets.load()}},activeModel:function(){return this.activeId?this.collection.get(this.activeId):null},activeView:function(){return this.activeId?this.childViews[this.activeId]:null},activateId:function(c){var b=this.activeView();var a=this.childViews[c];if(b){b.deactivate()}if(a){if(a.$el.hasClass("collapsed-child")){this.activateId(a.model.get("parent_id"))}else{a.activate();this.activeId=c}}return this},activateHash:function(){var a=window.location.hash.match(/^#(\d+)$/);if(a){return this.activateId(a[1])}},activateNeighbor:function(c){var a=this.activeModel();var b;if(a){b=a[c]({is_new:true},true)}else{b=(c==="next")?this.collection.first():this.collection.last();while(b&&!b.get("is_new")){b=b[c]()}}if(b){return this.activateId(b.id)}},activatePrev:function(){if(this.collection.loaded){this.activateNeighbor("prev")}else{this.loadThenRun("activatePrev")}},activateNext:function(){if(this.collection.loaded){this.activateNeighbor("next")}else{this.loadThenRun("activateNext")}},markRead:function(){var b=this.activeModel();var a=this.activeView();if(b){b.set("is_new",false);b.trigger("markRead")}if(a){a.deactivate()}},markAllRead:function(){_.each(this.collection.where({is_new:true}),function(a){a.set("is_new",false)})},markAllUnread:function(){this.collection.each(function(a){a.set("is_new",true)});if(!this.activeId){this.activeId=this.collection.first().id}},markReadAndActivateNext:function(){if(this.collection.loaded){this.markRead();this.activateNext()}else{this.loadThenRun("markReadAndActivateNext")}},replyToCurrent:function(){var a=this.activeView();if(a){a.reply()}},loadThenRun:function(a){jQuery("html, body").animate({scrollTop:this.$el.offset().top-Chorus.Comments.settings.offsetHeight},{duration:Chorus.Comments.settings.animationDuration});if(!Chorus.Comments.settings.startOnScroll){Chorus.Comments.start()}this.listenToOnce(this.collection,"loadSuccess",this[a])}});Chorus.Comments.Views.CommentsClosedNotice=Backbone.View.extend({templateId:"comments-closed-notice-template",render:function(){this.$el.html(this.template());this.trigger("render",this);return this}});Chorus.Comments.Views.EditForm=Backbone.View.extend({className:"cedit cform",templateId:"comment-edit-form-template",events:{"submit form":"submit","click .post_edit_button":"submit","click .cancel_edit_button":"cancel"},render:function(){this.$el.html(this.template({comment:this.model.toJSON()}));this.$("textarea").markItUp(Chorus.Comments.settings.markItUp);this.trigger("render",this);return this},formData:function(){var a=this.$("form").serializeArray();var b={};_.each(a,function(c){b[c.name]=c.value});return b},submit:function(){var a=this.$(".post_edit_button");a.prop("disabled",true).val("Saving...");this.model.once("editSuccess",function(){this.cancel()},this);this.model.once("editError",function(){a.prop("disabled",false).val("Save")},this);this.model.edit(this.formData());return false},cancel:function(){this.remove();this.trigger("cancel");return false}});Chorus.Comments.Views.FlagDialog=Backbone.View.extend({templateId:"comment-flag-dialog-template",events:{"submit form":"submit"},render:function(){var a=this.template({comment:this.model.toJSON()});Chorus.Comments.openModal(a);this.setElement("#comment_flag_modal");this.trigger("render",this);return this},submit:function(){this.model.flag(this.$("form").serialize());Chorus.Comments.closeModal();return false}});Chorus.Comments.Views.Footer=Backbone.View.extend({templateId:"comments-footer-template",render:function(){this.$el.html(this.template());this.trigger("render",this);return this}});Chorus.Comments.Views.FormattingGuide=Backbone.View.extend({id:"comment_formatting_guide",templateId:"comment-formatting-guide-template",render:function(){this.$el.html(this.template()).hide();this.trigger("render",this);return this}});Chorus.Comments.Views.Header=Backbone.View.extend({className:"comments-header ui-state-unloaded",templateId:"comments-header-template",events:{"click .show_comments_link":"loadComments","click .tips_link":"toggleTips","click .auto_update_alert_toggle":"toggleAutoUpdateAlert","click .touch_tools_toggle":"toggleTouchTools"},initialize:function(){this.listenTo(Chorus.Comments,"start",this.showLoadingIndicator);this.listenTo(this.collection,"loadSuccess",this.hideLoadingIndicator);this.listenTo(this.collection,"loadError",this.showLoadError);this.listenTo(this.collection,"loadSuccess",this.render);this.listenTo(this.collection,"updateSuccess",this.updateCount)},render:function(){this.$el.html(this.template({context:Chorus.Comments.context,settings:Chorus.Comments.settings}));this.trigger("render",this);return this},loadComments:function(){Chorus.Comments.start();return false},toggleTips:function(){this.$el.toggleClass("ui-state-tips-active");return false},showLoadError:function(){this.$el.removeClass("ui-state-loaded").removeClass("ui-state-unloaded").removeClass("ui-state-loading").addClass("ui-state-load-error")},showLoadingIndicator:function(){this.$el.removeClass("ui-state-loaded").removeClass("ui-state-unloaded").removeClass("ui-state-load-error").addClass("ui-state-loading")},hideLoadingIndicator:function(){this.$el.removeClass("ui-state-unloaded").removeClass("ui-state-loading").removeClass("ui-state-load-error").addClass("ui-state-loaded")},updateCount:function(){this.$(".count").text(this.collection.length)},toggleAutoUpdateAlert:function(){var a=!Chorus.Comments.settings.showAutoUpdateAlert;Chorus.Comments.settings.showAutoUpdateAlert=a;this.$(".auto_update_alert_toggle").text(a?"Hide it!":"Show it!");return false},toggleTouchTools:function(){if(Chorus.Comments.view.touchTools){Chorus.Comments.view.touchTools.toggle()}return false}});Chorus.Comments.Views.InspectFlagsDialog=Backbone.View.extend({templateId:"comment-inspect-flags-dialog-template",render:function(){if(!this.model.flaggingsLoaded){this.model.once("loadFlaggingsSuccess",this.render,this);this.model.loadFlaggings();return this}var a=this.template({comment:this.model.toJSON(),flaggings:_.invoke(this.model.flaggings(),"toJSON")});Chorus.Comments.openModal(a);this.setElement("#inspect_flags_modal");this.trigger("render",this);return this}});Chorus.Comments.Views.MainForm=Chorus.Comments.Views.BaseForm.extend({id:"main_comment_form",className:"cform cform-main",templateId:"comment-main-form-template",submitText:"Post",events:function(){var a=_.clone(Chorus.Comments.Views.BaseForm.prototype.events);a["click #formatting_guide_links a"]="toggleFormattingGuide";return a},render:function(){this.$el.html(this.template({context:Chorus.Comments.context}));this.$("textarea").markItUp(Chorus.Comments.settings.markItUp);var a=new Chorus.Comments.Views.FormattingGuide();a.render().$el.appendTo(this.el);this.trigger("render",this);return this},cancel:function(){if(this.previewView){this.previewView.remove();this.previewView=null}this.$(".preview-controls").hide();this.$(".post_comment_button").prop("disabled",false).val("Post");this.$(".preview_comment_button").prop("disabled",false).val("Preview");this.$("form").get(0).reset();this.trigger("cancel");return false},toggleFormattingGuide:function(a){jQuery(a.target).hide().siblings().show();jQuery("#comment_formatting_guide").slideToggle();return false}});Chorus.Comments.Views.Main=Backbone.View.extend({events:{"click .spoiler":"toggleSpoiler"},initialize:function(){var a=Chorus.Comments.Views;this.header=new a.Header({collection:this.collection});this.commentList=new a.CommentList({collection:this.collection});this.footer=new a.Footer();if(Chorus.Comments.settings.startOnScroll){this.pollScrollPosition()}this.listenTo(this.collection,"loadSuccess",this.renderWithContext);this.listenTo(this.collection,"loadError",this.renderError)},render:function(){this.$el.append(this.header.render().el,this.commentList.render().el);this.trigger("render",this);return this},remove:function(){this.header.remove();this.commentList.remove();this.footer.remove();if(this.mainForm){this.mainForm.remove()}if(this.touchTools){this.touchTools.remove()}if(this.autoUpdateAlert){this.autoUpdateAlert.remove()}this.$el.remove();return this},renderWithContext:function(){var e=Chorus.Comments.Views;var c=Chorus.Comments.context;var d=Chorus.Comments.settings;var a=false;if(c.comments_closed){this.mainForm=new e.CommentsClosedNotice()}else{if(c.able_to_comment){this.mainForm=new e.MainForm({collection:this.collection})}else{this.mainForm=new Backbone.View();a=true}}var b=new e.AccountActions();this.$el.append(b.render().el,this.mainForm.render().el,this.footer.render().el);if(a&&!_.isUndefined(Chorus.Auth)){Chorus.Auth.init()}if(c.able_to_comment&&!c.comments_closed&&Chorus.Environment.touch()){this.touchTools=new e.TouchTools({collection:this.collection});this.touchTools.render().$el.appendTo(this.el)}if(d.autoUpdateEnabled&&d.showAutoUpdateAlert){this.autoUpdateAlert=new e.AutoUpdateAlert({collection:this.collection});this.autoUpdateAlert.render().$el.appendTo(this.el)}this.trigger("render",this);return this},renderError:function(){this.$el.append('<h2 class="comments-load-error-msg">There was an error loading the comments. Please try again later</h2>')},pollScrollPosition:function(){var c=this.$el;var d=jQuery(window);var a=Chorus.Comments.settings.scrollBuffer;var b=function(){if(c.offset().top-d.scrollTop()-d.height()-a<0){Chorus.Comments.start()}};b=_.throttle(b,200);b();d.on("scroll",b);Chorus.Comments.once("start",function(){d.off("scroll",b)})},toggleSpoiler:function(a){jQuery(a.target).toggleClass("reveal_spoiler");return false}});Chorus.Comments.Views.ReplyForm=Chorus.Comments.Views.BaseForm.extend({className:"cform",templateId:"comment-reply-form-template",submitText:"Reply",renderTo:function(a){this.$el.html(this.template({context:Chorus.Comments.context,comment:this.model.toJSON()}));this.$("textarea").markItUp(Chorus.Comments.settings.markItUp);this.$el.appendTo(a);this.$("[autofocus]:first").focus();this.trigger("render",this);return this},cancel:function(){this.remove();this.trigger("cancel");return false}});Chorus.Comments.Views.TouchTools=Backbone.View.extend({id:"comment_touch_tools",templateId:"comment-touch-tools-template",events:{"click .close":"toggle","click .refresh":"refresh","click .next":"activateNext","click .mark":"markAllRead"},initialize:function(){this.listenTo(this.collection,"updateSuccess updateError",this.stopLoading)},render:function(){this.$el.html(this.template());this.trigger("render",this);return this},toggle:function(){this.$el.toggle();return false},refresh:function(){this.$el.addClass("loading");this.collection.update();return false},stopLoading:function(){this.$el.removeClass("loading")},activateNext:function(){Chorus.Comments.view.commentList.markReadAndActivateNext();return false},markAllRead:function(){Chorus.Comments.view.commentList.markAllRead();return false}});var Chorus=Chorus||{};Chorus.HubAdminMenu=(function(a){return{init:function(){jQuery(function(b){b("#hub-admin-menu").click(function(){b(this).toggleClass("is-open")})})}}})(jQuery);jQuery(function(){Chorus.HubAdminMenu.init()});var Kicksend={mailcheck:{threshold:3,defaultDomains:"yahoo.com google.com hotmail.com gmail.com me.com aol.com mac.com live.com comcast.net googlemail.com msn.com hotmail.co.uk yahoo.co.uk facebook.com verizon.net sbcglobal.net att.net gmx.com mail.com".split(" "),defaultTopLevelDomains:"co.uk com net org info edu gov mil".split(" "),run:function(d){d.domains=d.domains||Kicksend.mailcheck.defaultDomains;d.topLevelDomains=d.topLevelDomains||Kicksend.mailcheck.defaultTopLevelDomains;d.distanceFunction=d.distanceFunction||Kicksend.sift3Distance;var c=Kicksend.mailcheck.suggest(encodeURI(d.email),d.domains,d.topLevelDomains,d.distanceFunction);c?d.suggested&&d.suggested(c):d.empty&&d.empty()},suggest:function(f,e,h,g){f=f.toLowerCase();f=this.splitEmail(f);if(e=this.findClosestDomain(f.domain,e,g)){if(e!=f.domain){return{address:f.address,domain:e,full:f.address+"@"+e}}}else{if(h=this.findClosestDomain(f.topLevelDomain,h),f.domain&&h&&h!=f.topLevelDomain){return e=f.domain,e=e.substring(0,e.lastIndexOf(f.topLevelDomain))+h,{address:f.address,domain:e,full:f.address+"@"+e}}}return !1},findClosestDomain:function(i,h,o){var n,m=99,j=null;if(!i||!h){return !1}o||(o=this.sift3Distance);for(var l=0;l<h.length;l++){if(i===h[l]){return i}n=o(i,h[l]);n<m&&(m=n,j=h[l])}return m<=this.threshold&&null!==j?j:!1},sift3Distance:function(i,h){if(null==i||0===i.length){return null==h||0===h.length?0:h.length}if(null==h||0===h.length){return i.length}for(var o=0,n=0,m=0,j=0;o+n<i.length&&o+m<h.length;){if(i.charAt(o+n)==h.charAt(o+m)){j++}else{for(var l=m=n=0;5>l;l++){if(o+l<i.length&&i.charAt(o+l)==h.charAt(o)){n=l;break}if(o+l<h.length&&i.charAt(o)==h.charAt(o+l)){m=l;break}}}o++}return(i.length+h.length)/2-j},splitEmail:function(g){g=g.split("@");if(2>g.length){return !1}for(var f=0;f<g.length;f++){if(""===g[f]){return !1}}var j=g.pop(),i=j.split("."),h="";if(0==i.length){return !1}if(1==i.length){h=i[0]}else{for(f=1;f<i.length;f++){h+=i[f]+"."}2<=i.length&&(h=h.substring(0,h.length-1))}return{topLevelDomain:h,domain:j,address:g.join("@")}}}};window.jQuery&&function(b){b.fn.mailcheck=function(f){var i=this;if(f.suggested){var h=f.suggested;f.suggested=function(c){h(i,c)}}if(f.empty){var g=f.empty;f.empty=function(){g.call(null,i)}}f.email=this.val();Kicksend.mailcheck.run(f)}}(jQuery);var Chorus=Chorus||{};Chorus.Auth=(function(a){return{config:function(b){this.element={wrapper:a(".m-auth-modal__wrapper"),modal:a(".m-auth-modal"),close:a(".m-auth-modal__close"),body:a(".m-auth-modal__body"),form:a(".m-auth-modal__form"),loginTable:a(".m-auth-modal__login-table"),loadingMsg:a("#chorus-auth-loading-message")};this.authTriggers={data:a("[data-chorus-auth]"),goTo:a("[data-chorus-auth-goto]"),auto:a("[data-chorus-auth-auto]"),facebook:a('[data-chorus-auth-login="facebook"]'),openId:a('[data-chorus-auth-login="openid"]'),twitter:a('[data-chorus-auth-login="twitter"]'),yahoo:a('[data-chorus-auth-login="yahoo"]'),password:a("#chorus-auth-password")};this.globals={serializedForm:""};this.openModalClass="-has-open-auth-modal";this.networkUrl=this.element.modal.data("chorus-auth-network-url");if(Chorus.Auth.helpers.noCorsSupport()){this.networkUrl=Chorus.Auth.helpers.httpNetworkUrl()}b()},defaultAjaxOptions:{xhrFields:{withCredentials:true}},init:function(){this.config(function(){if(!Chorus.Auth.networkUrl){return}if(window.addEventListener){window.addEventListener("message",function(b){var d=Chorus.Auth.helpers.httpNetworkUrl();if(b.origin===d){var c=JSON.parse(b.data);if(c.is_from_chorus_auth){Chorus.Auth.actions.callbacks.chorusAuth(c)}}},false)}Chorus.Auth.events.bind();Chorus.Auth.helpers.placeholderPolyfill();Chorus.Auth.helpers.checkForAutoLoad()})},events:{bind:function(){Chorus.Auth.authTriggers.data.on("click",Chorus.Auth.modal.open);Chorus.Auth.authTriggers.goTo.on("click",Chorus.Auth.modal.goTo);Chorus.Auth.element.wrapper.on("click",Chorus.Auth.modal.close);Chorus.Auth.element.modal.find(Chorus.Auth.element.close).on("click",Chorus.Auth.modal.close);Chorus.Auth.authTriggers.password.on("submit",Chorus.Auth.actions.login.password);var e=Chorus.Auth.modal.goTo("forgot",true);e.find("form").on("submit",Chorus.Auth.actions.form.startSubmission);Chorus.Auth.authTriggers.facebook.on("click",Chorus.Auth.actions.login.facebook);Chorus.Auth.authTriggers.twitter.on("click",Chorus.Auth.actions.login.twitter);Chorus.Auth.authTriggers.yahoo.on("click",Chorus.Auth.actions.login.yahoo);Chorus.Auth.authTriggers.openId.on("click",Chorus.Auth.actions.showOpenIdForm);Chorus.Auth.element.form.filter(".openid").on("submit",Chorus.Auth.actions.login.openId);var g=["join","register-join"];for(var c=0;c<g.length;c++){var d=Chorus.Auth.modal.goTo(g[c],true);d.find('input[type="checkbox"]').on("change",Chorus.Auth.actions.validate.checkboxEnablesForm);d.find("form").on("submit",Chorus.Auth.actions.form.startSubmission)}Chorus.Auth.modal.goTo("umbel-permissions",true).find("form").on("submit",Chorus.Auth.actions.form.startSubmission);var f=Chorus.Auth.modal.goTo("third-party-register",true);f.find('[name="user[username]"]').on("focus",Chorus.Auth.actions.validate.validationEnablesForm);f.find('[name="user[username]"]').on("focus blur",Chorus.Auth.actions.validate.username);f.find("form").on("submit",Chorus.Auth.actions.form.startSubmission);Chorus.Auth.modal.goTo("captcha",true).find("form").on("submit",Chorus.Auth.actions.form.startSubmission);var b=Chorus.Auth.modal.goTo("register",true);b.find('[name="user[username]"]').on("blur",Chorus.Auth.actions.validate.username);b.find('[name="user[password]"]').on("blur",Chorus.Auth.actions.validate.password);b.find('[name="user[email]"]').on("blur",Chorus.Auth.actions.validate.email);b.find('[name="user[email]"]').on("blur",Chorus.Auth.actions.validate.suggestEmail);b.find("form").on("submit",Chorus.Auth.actions.form.startSubmission)}},actions:{validate:{email:function(c){var b=Chorus.Auth.actions.validate.getInputContext(c);b.errorId="email";if(!_.isEmpty(b.value)){Chorus.Auth.actions.validate.testAgainstJSON("email_valid",{email:b.value},b)}else{b.status.removeClass("error success");Chorus.Auth.actions.validate.errors.clear(b)}},suggestEmail:function(c){var b=Chorus.Auth.actions.validate.getInputContext(c);b.errorId="suggest-email";a(b.input).mailcheck({suggested:function(e,d){Chorus.Auth.actions.validate.errors.show(b,"Did you mean "+d.full+"?")},empty:function(d){Chorus.Auth.actions.validate.errors.clear(b)}})},username:function(b){var c=Chorus.Auth.actions.validate.getInputContext(b);c.errorId="username";if(!_.isEmpty(c.value)){Chorus.Auth.actions.validate.testAgainstJSON("username_available",{username:c.value},c)}else{c.status.removeClass("error success")}},password:function(d){var c=Chorus.Auth.actions.validate.getInputContext(d);c.errorId="password";if(!_.isEmpty(c.value)){var b=(c.value.length>=6&&c.value.match(/\d/)&&c.value.match(/\d/).length&&c.value.match(/[a-z]/i)&&c.value.match(/[a-z]/i).length)?true:false;Chorus.Auth.actions.validate.addCheckOrX(b,c)}else{c.status.removeClass("error success")}},checkboxEnablesForm:function(d){var c=Chorus.Auth.actions.validate.getInputContext(d);c.errorId="checkbox";var b=c.modalObj.find('[type="submit"]');if(c.input.is(":checked")){b.removeAttr("disabled")}else{b.attr("disabled",true)}},getInputContext:function(f){var c=a(f.target);var d=c.parents(Chorus.Auth.element.body.selector);var b={input:c,status:c.parent(),value:c.val(),modal:d.data("chorus-auth-modal"),modalObj:d,errorMsg:c.data("error-msg"),errorEl:c.parent().find("h6")};return b},testAgainstJSON:function(b,d,c){a.getJSON(Chorus.Auth.networkUrl+"/chorus_auth/"+b+".json?callback=?",d).success(function(e){Chorus.Auth.actions.validate.addCheckOrX(e,c)})},addCheckOrX:function(c,b){if(c.available||(_.isBoolean(c)&&c)){b.status.addClass("success");b.status.removeClass("error");Chorus.Auth.actions.validate.errors.clear(b)}else{b.status.addClass("error");b.status.removeClass("success");if(_.isUndefined(c.message)){Chorus.Auth.actions.validate.errors.show(b)}else{Chorus.Auth.actions.validate.errors.show(b,c.message)}}},isFormValid:function(c){var b=a(c.target);var f=b.find("fieldset").filter("[data-chorus-auth-validate]").length;var d=b.find("fieldset").filter("[data-chorus-auth-validate].success").length;return(f===d)},errors:{show:function(c,d){var b=(_.isUndefined(d))?c.errorMsg:d;if(!c.status.find("#"+c.errorId).length){a("<h6/>").appendTo(c.status).attr("id",c.errorId).text(b);if(!c.status.hasClass("error")){c.status.addClass("error");c.status.removeClass("success")}}},clear:function(b){b.status.find("#"+b.errorId).remove()}}},form:{startSubmission:function(d){var b=a(d.target).parents(Chorus.Auth.element.body.selector);switch(b.data("chorus-auth-modal")){case"forgot":Chorus.Auth.modal.spinner("Sending...");var c=a(d.target).find("[name='email']").val();a.ajax(_.extend({type:"post",url:Chorus.Auth.networkUrl+"/chorus_auth/request_password_reset.json",data:{email:c},dataType:"json",success:function(g){var e=Chorus.Auth.modal.goTo("forgot-result",true);e.find("p.error").text("");e.find("p.success").text(g.message);Chorus.Auth.modal.goTo("forgot-result")},error:function(j,g,i){var h=JSON.parse(j.responseText);var e=Chorus.Auth.modal.goTo("forgot-result",true);e.find("p.success").text("");e.find("p.error").text(data.message);Chorus.Auth.modal.goTo("forgot-result")}},Chorus.Auth.defaultAjaxOptions));break;case"join":Chorus.Auth.actions.form.submitJoin();break;case"register-join":if(Chorus.Auth.isCaptchaRequired){Chorus.Auth.modal.goTo("captcha")}else{Chorus.Auth.actions.form.completeSubmission()}break;case"umbel-permissions":Chorus.Auth.actions.form.serialize(d.target);Chorus.Auth.modal.goTo("third-party-register");break;case"third-party-register":if(Chorus.Auth.actions.validate.isFormValid(d)){Chorus.Auth.actions.form.serialize(d.target);Chorus.Auth.isCaptchaRequired=false;if(Chorus.Auth.modal.goTo("register-join",true).length){Chorus.Auth.modal.goTo("register-join")}else{Chorus.Auth.actions.form.completeSubmission()}}break;case"captcha":Chorus.Auth.actions.form.serialize(d.target);Chorus.Auth.actions.form.completeSubmission(Chorus.Auth.actions.captcha.error);break;case"register":if(Chorus.Auth.actions.validate.isFormValid(d)){Chorus.Auth.provider="password";Chorus.Auth.actions.form.serialize(d.target);Chorus.Auth.actions.captcha.init("chorus-auth-register-recaptcha");var f=a(d.target).find("[name='user[username]']").val();Chorus.Auth.modal.goTo("captcha",true).find("span.username").text(f);Chorus.Auth.isCaptchaRequired=true;if(Chorus.Auth.modal.goTo("register-join",true).length){Chorus.Auth.modal.goTo("register-join")}else{Chorus.Auth.modal.goTo("captcha")}}break}d.preventDefault()},completeSubmission:function(b){a.ajax(_.extend({type:"post",url:Chorus.Auth.networkUrl+"/chorus_auth/register.json",data:Chorus.Auth.globals.serializedForm,dataType:"json",success:function(c){Chorus.Auth.actions.login.completeLogin("Register")},error:function(f,c,e){var d=JSON.parse(f.responseText);b(d.message)}},Chorus.Auth.defaultAjaxOptions));Chorus.Auth.modal.spinner("Registering");return false},submitJoin:function(){var b=Chorus.Auth.networkUrl+"/chorus_auth/join_community.json";if(!!Chorus.Context.community_id){b=b+"?community_id="+Chorus.Context.community_id}a.ajax(_.extend({type:"post",url:b,dataType:"json",success:function(c){window.location.reload()},error:function(f,c,e){var d=JSON.parse(f.responseText);console.log(d.message)}},Chorus.Auth.defaultAjaxOptions));Chorus.Auth.modal.spinner("Registering");return false},serialize:function(b){if(!_.isEmpty(Chorus.Auth.globals.serializedForm)){Chorus.Auth.globals.serializedForm+="&"}Chorus.Auth.globals.serializedForm+=a(b).serialize()}},captcha:{init:function(b){a(".m-auth-modal__captcha-container").html("");a.ajax(_.extend({dataType:"html",url:Chorus.Auth.networkUrl+"/chorus_auth/recaptcha",success:function(c){a("#"+b).html(c);a.getScript("http://www.google.com/recaptcha/api/js/recaptcha_ajax.js",function(){Recaptcha.destroy();Recaptcha.create("6LcgS98SAAAAAJLeEKGYuZxRROAovJl-ltyOgAC4",b,{theme:"custom"});var d=setInterval(function(){if(a(".m-auth-modal__recaptcha #recaptcha_image img").length){a(".m-auth-modal__recaptcha #recaptcha_image").removeAttr("style").find("img").removeAttr("width height");clearInterval(d)}},500)})}},Chorus.Auth.defaultAjaxOptions))},error:function(b){Recaptcha.reload();Chorus.Auth.modal.goTo("captcha",true).find("p.error").text(b);Chorus.Auth.modal.goTo("captcha")}},callbacks:{thirdParty:function(f,d,b){var e=Chorus.Auth.modal.goTo("third-party-register",true);if(!_.isUndefined(d)){var c=e.find('[name="user[username]"]');c.val(d);c.focus()}if(!_.isUndefined(b)){e.find(".m-auth-modal__avatar").attr("src",b)}},chorusAuth:function(c){if(c.logged_in){Chorus.Auth.actions.login.completeLogin("Login")}else{if(!_.isUndefined(c.error)){var b=Chorus.Auth.modal.goTo("register",true);b.find("p.error").text(c.error);Chorus.Auth.modal.goTo("register")}else{if(typeof ga==="function"){ga("send","event","SimpleAuth","Start Registration",c.provider)}else{if(typeof _gaq==="object"){_gaq.push(["_trackEvent","SimpleAuth","Start Registration",c.provider])}}Chorus.Auth.actions.callbacks.thirdParty(c.provider,c.username,c.profile_image_url);if(c.provider==="facebook"){Chorus.Auth.modal.goTo("umbel-permissions")}else{Chorus.Auth.modal.goTo("third-party-register")}}}}},login:{yahoo:function(b){Chorus.Auth.actions.openAuthWindow(Chorus.Auth.networkUrl+"/chorus_auth/initiate_yahoo_auth");Chorus.Auth.provider="yahoo";b.preventDefault()},openId:function(c){var b=a(c.target).find("[name='openid']").val();Chorus.Auth.actions.openAuthWindow(Chorus.Auth.networkUrl+"/chorus_auth/initiate_openid_auth?openid_url="+b);Chorus.Auth.provider="open_id";c.preventDefault()},twitter:function(c){var b=Chorus.Auth.networkUrl+"/chorus_auth/initiate_twitter_auth";Chorus.Auth.actions.openAuthWindow(b);Chorus.Auth.provider="twitter";c.preventDefault()},facebook:function(b){Chorus.Auth.actions.openAuthWindow(Chorus.Auth.networkUrl+"/chorus_auth/initiate_facebook_auth");Chorus.Auth.provider="facebook";b.preventDefault()},gplus:function(b){Chorus.Auth.provider="google_plus";if(b.code&&b["g-oauth-window"]){Chorus.Auth.modal.spinner("Authenticating");a.ajax(_.extend({type:"POST",url:Chorus.Auth.networkUrl+"/chorus_auth/finalize_google_plus_auth.json?",data:{code:b.code},success:function(c){Chorus.Auth.actions.callbacks.chorusAuth(c)},dataType:"json"},Chorus.Auth.defaultAjaxOptions))}},password:function(c){var b=a(c.target);var d=function(e){Chorus.Auth.provider="password";if(e.logged_in){Chorus.Auth.actions.login.completeLogin("Login")}else{if(e.captcha_required){Chorus.Auth.actions.captcha.init("chorus-auth-login-recaptcha")}b.find("p.error").text(e.message);Chorus.Auth.modal.goTo("login")}};a.ajax(_.extend({type:"POST",url:Chorus.Auth.networkUrl+"/chorus_auth/initiate_password_auth.json",data:b.serialize(),success:d,dataType:"json"},Chorus.Auth.defaultAjaxOptions));Chorus.Auth.modal.spinner("Logging in...");c.preventDefault()},completeLogin:function(b){if(Chorus.Auth.networkUrl.indexOf("sbnation.com")>0){ga("send","event","SimpleAuth",b,Chorus.Auth.provider)}else{_gaq.push(["_trackEvent","SimpleAuth",b,Chorus.Auth.provider])}setTimeout(function(){window.location.reload()},100)}},openAuthWindow:function(c){Chorus.Auth.modal.spinner("Authenticating");var b=window.open(c,"_blank","height=450,width=800,menubar=yes,status=yes,scrollbars=yes,resizable=yes,titlebar=yes,toolbar=no,menubar=yes,location=yes");if(!b){alert("welp, window blocked")}},resetLoginOptions:function(){Chorus.Auth.element.loginTable.each(function(){a(this).find("tr").not(":first").addClass("other")});Chorus.Auth.element.form.filter(".openid").hide()},showOpenIdForm:function(d){var b=a(d.target);var c=b.parents(Chorus.Auth.element.body.selector);c.find(Chorus.Auth.element.form).filter(".openid").toggle();d.preventDefault()}},modal:{open:function(f){var c=a("body");var b=(_.isObject(f))?a(this).data("chorus-auth"):f;if(Chorus.Auth.helpers.noCorsSupport()&&Chorus.Auth.helpers.notOnNetworkDomain()){var g=Chorus.Auth.helpers.httpNetworkUrl();var d=window.location.href.split("?")[0];window.location.href=g+"/login?return_to="+d}else{Chorus.Auth.element.modal.find('[data-chorus-auth-modal="'+b+'"]').show();Chorus.EventDispatcher.publish("modal_open",{content:Chorus.Auth.element.modal})}if(_.isObject(f)){f.preventDefault()}},close:function(b){if(b.target===this){a("body").removeClass(Chorus.Auth.openModalClass);Chorus.Auth.element.wrapper.hide();Chorus.Auth.element.modal.find("[data-chorus-auth-modal]").hide();Chorus.Auth.actions.resetLoginOptions();b.preventDefault()}},goTo:function(d,b){var f=(_.isObject(d))?a(this).data("chorus-auth-goto"):d;var c=Chorus.Auth.element.body.filter('[data-chorus-auth-modal="'+f+'"]');if(_.isUndefined(b)){Chorus.Auth.element.body.filter(":visible").hide();c.show()}else{return c}if(_.isObject(d)){d.preventDefault()}},spinner:function(b){Chorus.Auth.element.loadingMsg.text(b);Chorus.Auth.modal.goTo("spinner")},moveIntoView:function(){var b=a(window).scrollTop();Chorus.Auth.element.modal.css("top",b)}},helpers:{placeholderPolyfill:function(){var b=document.createElement("input");if("placeholder" in b){return}else{Chorus.Auth.element.modal.find("[placeholder]").focus(function(){var c=a(this);if(c.val()===c.attr("placeholder")){c.val("");c.removeClass("placeholder")}}).blur(function(){var c=a(this);if(c.val()===""||c.val()===c.attr("placeholder")){c.addClass("placeholder");c.val(c.attr("placeholder"))}}).blur()}},checkForAutoLoad:function(){if(Chorus.Auth.authTriggers.auto.length===1){var b=Chorus.Auth.authTriggers.auto.eq(0).data("chorus-auth-auto");Chorus.Auth.modal.open(b)}},httpNetworkUrl:function(){if(Chorus.Auth.networkUrl==null){return null}else{return Chorus.Auth.networkUrl.replace(/^https:\/\//,"http://")}},noCorsSupport:function(){return window.navigator.userAgent.match(/MSIE (6|7|8|9)/)},notOnNetworkDomain:function(){return window.location.href.indexOf(Chorus.Auth.helpers.httpNetworkUrl())!==0}}}})(jQuery);jQuery(function(){Chorus.Auth.init()});