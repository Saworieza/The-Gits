/**
 * @version $Id: djmegamenu.js 19 2014-03-05 16:22:46Z szymon $
 * @package DJ-MegaMenu
 * @copyright Copyright (C) 2013 DJ-Extensions.com, All rights reserved.
 * @license DJ-Extensions.com Proprietary Use License
 * @author url: http://dj-extensions.com
 * @author email contact@dj-extensions.com
 * @developer Szymon Woronowski - szymon.woronowski@design-joomla.eu
 */
(function(){this.afterDJMegaMenuHide=function(){};this.DJMegaMenus=new Class({Implements:Options,options:{transition:'cubic:out',duration:300,delay:500,h:true,w:true,o:true,hs:true,ws:true,os:true,wrap:null,direction:'ltr',event:'mouseenter',touch:(Browser.Platform.ios||Browser.Platform.android||Browser.Platform.webos)},initialize:function(b,c){this.setOptions(c);if(!b)return;var d=b.getChildren('li.dj-up');this.kids=new Array();if(!this.options.wrap)this.options.wrap=b;this.options.direction=window.getComputedStyle(document.body).getPropertyValue('direction');d.each(function(a){this.kids.include(new i(a,0,this,this.options))}.bind(this));if(this.options.fixed&&!this.options.touch){window.addEvent('load',this.makeSticky.bind(this,b))}},makeSticky:function(a){this.sticky=false;var b=new Element('div',{id:a.get('id')+'sticky'});b.addClass('dj-megamenu');b.addClass('dj-megamenu-sticky');b.setStyles({position:'fixed',top:this.options.offset,left:0,width:'100%'});var c=a.getPosition().y-this.options.offset;var d=a.clone(true);d.set('id',a.get('id')+'placeholder');d.setStyle('opacity',0);var e=this.options.direction=='rtl'?'right':'left';window.addEvent('scroll',this.scroll.pass([b,a,d,c,e,false],this));window.addEvent('resize',this.scroll.pass([b,a,d,c,e,true],this))},scroll:function(a,b,c,d,e,f){if(window.getScroll().y>d){if(!this.sticky){var g=b.getCoordinates();var h=e=='left'?g.left:window.getSize().x-g.left-g.width;b.setStyle(e,h);c.inject(b,'before');a.wraps(b);this.sticky=true}else if(f){var g=c.getCoordinates();var h=e=='left'?g.left:window.getSize().x-g.left-g.width;b.setStyle(e,h)}}else if(this.sticky){b.replaces(c);b.setStyle(e,'');a.dispose();this.sticky=false}}});var i=new Class({Implements:Options,options:{},initialize:function(a,b,c,d){this.setOptions(d);this.menu=a;this.level=b;this.parent=c;this.hover=false;this.sub=a.getElement('.dj-subwrap');var f='mouseenter';if(this.options.touch||this.options.event=='click_all'){f='click';var g=a.getElement('a');if(g&&g.getParent()==a){if(a.hasClass('separator'))g.setStyle('cursor','pointer');g.addEvent('click',function(e){if(this.sub&&!this.menu.hasClass('hover'))e.preventDefault()}.bind(this))}if(this.sub)this.sub.setStyle('visibility','hidden')}else if(this.options.event=='click'&&a.hasClass('separator')){var g=a.getElement('a');if(g&&g.getParent()==a)g.setStyle('cursor','pointer');if(this.sub)this.sub.setStyle('visibility','hidden');f='click'}this.menu.addEvent(f,this.showSub.bind(this));this.menu.addEvent('mouseleave',this.hideSub.bind(this));if(this.sub){this.subFX=new Fx.Morph(this.sub,{transition:this.options.transition,duration:this.options.duration,link:'cancel'}).addEvent('onComplete',this.complete.bind(this)).addEvent('onStart',this.start.bind(this)).addEvent('onCancel',this.cancel.bind(this));this.kids=new Array();this.initKids()}},showSub:function(){this.hover=true;if(this.sub&&this.menu.hasClass('hover')&&this.sub.getStyle('overflow')=='visible'){return}this.menu.addClass('hover');if(this.sub&&!this.show)this.initHovered();this.hideOther();if(this.sub){if(this.level>0)this.parent.sub.setStyle('overflow','visible');this.subFX.start(this.show)}},hideSub:function(){this.hover=false;if(this.sub){(function(){if(this.hover)return;this.subFX.start(this.hide).chain(function(){this.menu.removeClass('hover');if((afterDJMegaMenuHide))afterDJMegaMenuHide()}.bind(this))}).delay(this.options.delay,this)}else{this.menu.removeClass('hover')}},start:function(){this.sub.setStyle('overflow','hidden')},complete:function(){this.sub.setStyle('overflow','visible');if(this.menu.hasClass('hover'))this.sub.setStyle('height','')},cancel:function(){this.subFX.clearChain()},initHovered:function(){this.sub.setStyle('visibility','visible');var a=this.sub.getCoordinates();var b=this.options.wrap.getCoordinates();if(this.options.wrap.hasClass('dj-megamenu')){var c=document.id(this.options.wrap.get('id')+'placeholder');if(c)b=c.getCoordinates()}if(this.options.direction=='ltr'){var d=a.left+a.width-b.width-b.left;if(d>0){if(this.level){this.sub.setStyle('right',this.sub.getStyle('left'));this.sub.setStyle('left','auto')}else{this.sub.setStyle('margin-left',-d)}}}else if(this.options.direction=='rtl'){var d=a.left-b.left;if(d<0){if(this.level){this.sub.setStyle('left',this.sub.getStyle('right'));this.sub.setStyle('right','auto')}else{this.sub.setStyle('margin-right',d)}}}this.show={'height':a.height,'width':a.width,'opacity':1};this.hide={'height':this.options.h?0:a.height,'width':this.options.w?0:a.width,'opacity':this.options.o?0:1};this.subFX.set(this.hide)},initKids:function(){var b=this.sub.getChildren('.dj-subcol > ul.dj-submenu > li');var c={h:this.options.hs,w:this.options.ws,o:this.options.os};var d=Object.clone(this.options);c=Object.merge(d,c);b.each(function(a){this.kids.include(new i(a,this.level+1,this,c))}.bind(this))},hideOther:function(){this.parent.kids.each(function(a){if(a.menu.hasClass('hover')&&a!=this){if(a.sub){a.hideOtherSub();a.subFX.start(a.hide).chain(function(){this.menu.removeClass('hover');if((afterDJMegaMenuHide))afterDJMegaMenuHide()}.bind(a))}}}.bind(this))},hideOtherSub:function(){this.kids.each(function(a){if(a.menu.hasClass('hover')){if(a.sub){a.hideOtherSub();a.subFX.cancel();a.subFX.set(a.hide)}a.menu.removeClass('hover')}})}})})();